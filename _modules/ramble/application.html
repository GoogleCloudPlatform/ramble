<!DOCTYPE html>
<html class="writer-html5" lang="en" data-content_root="../../">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>ramble.application &mdash; Ramble 0.3.0 documentation</title>
      <link rel="stylesheet" type="text/css" href="../../_static/pygments.css?v=80d5e7a1" />
      <link rel="stylesheet" type="text/css" href="../../_static/css/theme.css?v=19f00094" />
      <link rel="stylesheet" type="text/css" href="../../_static/graphviz.css?v=eafc0fe6" />

  
  <!--[if lt IE 9]>
    <script src="../../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
        <script src="../../_static/jquery.js?v=5d32c60e"></script>
        <script src="../../_static/_sphinx_javascript_frameworks_compat.js?v=2cd50e6c"></script>
        <script src="../../_static/documentation_options.js?v=e259d695"></script>
        <script src="../../_static/doctools.js?v=888ff710"></script>
        <script src="../../_static/sphinx_highlight.js?v=dc90522c"></script>
    <script src="../../_static/js/theme.js"></script>
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >

          
          
          <a href="../../index.html">
            
          </a>
              <div class="version">
                0.3
              </div>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <p class="caption" role="heading"><span class="caption-text">Tutorials</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../tutorials.html">Tutorials</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Basics</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../ramble.html">ramble package</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../getting_started.html">Getting Started</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../configuration_files.html">Configuration Files</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../workspace.html">Ramble Workspace</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../workspace_config.html">Workspace Configuration File</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../success_criteria.html">Success Criteria</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Contributing</span></p>
<ul>
<li class="toctree-l1"><a class="reference external" href="https://github.com/GoogleCloudPlatform/ramble#contributing">Contributing Guidelines</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../dev_guides.html">Developer Guides</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">External Resources</span></p>
<ul>
<li class="toctree-l1"><a class="reference external" href="https://github.com/spack/spack">Spack</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../index.html">Ramble</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../../index.html" class="icon icon-home" aria-label="Home"></a></li>
          <li class="breadcrumb-item"><a href="../index.html">Module code</a></li>
      <li class="breadcrumb-item active">ramble.application</li>
      <li class="wy-breadcrumbs-aside">
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <h1>Source code for ramble.application</h1><div class="highlight"><pre>
<span></span><span class="c1"># Copyright 2022-2023 Google LLC</span>
<span class="c1">#</span>
<span class="c1"># Licensed under the Apache License, Version 2.0 &lt;LICENSE-APACHE or</span>
<span class="c1"># https://www.apache.org/licenses/LICENSE-2.0&gt; or the MIT license</span>
<span class="c1"># &lt;LICENSE-MIT or https://opensource.org/licenses/MIT&gt;, at your</span>
<span class="c1"># option. This file may not be copied, modified, or distributed</span>
<span class="c1"># except according to those terms.</span>
<span class="sd">&quot;&quot;&quot;Define base classes for application definitions&quot;&quot;&quot;</span>

<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">stat</span>
<span class="kn">import</span> <span class="nn">re</span>
<span class="kn">import</span> <span class="nn">six</span>
<span class="kn">import</span> <span class="nn">textwrap</span>
<span class="kn">import</span> <span class="nn">string</span>
<span class="kn">import</span> <span class="nn">shutil</span>
<span class="kn">import</span> <span class="nn">fnmatch</span>
<span class="kn">import</span> <span class="nn">enum</span>
<span class="kn">from</span> <span class="nn">typing</span> <span class="kn">import</span> <span class="n">List</span>

<span class="kn">import</span> <span class="nn">llnl.util.filesystem</span> <span class="k">as</span> <span class="nn">fs</span>
<span class="kn">import</span> <span class="nn">llnl.util.tty.color</span> <span class="k">as</span> <span class="nn">color</span>
<span class="kn">from</span> <span class="nn">llnl.util.tty.colify</span> <span class="kn">import</span> <span class="n">colified</span>

<span class="kn">import</span> <span class="nn">spack.util.executable</span>
<span class="kn">import</span> <span class="nn">spack.util.spack_json</span>
<span class="kn">import</span> <span class="nn">spack.util.environment</span>
<span class="kn">import</span> <span class="nn">spack.util.compression</span>

<span class="kn">import</span> <span class="nn">ramble.config</span>
<span class="kn">import</span> <span class="nn">ramble.stage</span>
<span class="kn">import</span> <span class="nn">ramble.mirror</span>
<span class="kn">import</span> <span class="nn">ramble.fetch_strategy</span>
<span class="kn">import</span> <span class="nn">ramble.expander</span>
<span class="kn">import</span> <span class="nn">ramble.keywords</span>
<span class="kn">import</span> <span class="nn">ramble.repository</span>
<span class="kn">import</span> <span class="nn">ramble.modifier</span>
<span class="kn">import</span> <span class="nn">ramble.util.executable</span>
<span class="kn">import</span> <span class="nn">ramble.util.colors</span> <span class="k">as</span> <span class="nn">rucolor</span>
<span class="kn">import</span> <span class="nn">ramble.util.hashing</span>
<span class="kn">import</span> <span class="nn">ramble.util.env</span>
<span class="kn">import</span> <span class="nn">ramble.util.directives</span>
<span class="kn">from</span> <span class="nn">ramble.util.logger</span> <span class="kn">import</span> <span class="n">logger</span>

<span class="kn">from</span> <span class="nn">ramble.workspace</span> <span class="kn">import</span> <span class="n">namespace</span>

<span class="kn">from</span> <span class="nn">ramble.language.application_language</span> <span class="kn">import</span> <span class="n">ApplicationMeta</span><span class="p">,</span> <span class="n">register_phase</span>
<span class="kn">from</span> <span class="nn">ramble.language.shared_language</span> <span class="kn">import</span> <span class="n">SharedMeta</span><span class="p">,</span> <span class="n">register_builtin</span>
<span class="kn">from</span> <span class="nn">ramble.error</span> <span class="kn">import</span> <span class="n">RambleError</span>


<div class="viewcode-block" id="ApplicationBase">
<a class="viewcode-back" href="../../ramble.html#ramble.application.ApplicationBase">[docs]</a>
<span class="k">class</span> <span class="nc">ApplicationBase</span><span class="p">(</span><span class="nb">object</span><span class="p">,</span> <span class="n">metaclass</span><span class="o">=</span><span class="n">ApplicationMeta</span><span class="p">):</span>
    <span class="n">name</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">uses_spack</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="n">_builtin_name</span> <span class="o">=</span> <span class="s1">&#39;builtin::</span><span class="si">{name}</span><span class="s1">&#39;</span>
    <span class="n">_exec_prefix_builtin</span> <span class="o">=</span> <span class="s1">&#39;builtin::&#39;</span>
    <span class="n">_mod_prefix_builtin</span> <span class="o">=</span> <span class="s1">&#39;modifier_builtin::&#39;</span>
    <span class="n">_builtin_required_key</span> <span class="o">=</span> <span class="s1">&#39;required&#39;</span>
    <span class="n">_workload_exec_key</span> <span class="o">=</span> <span class="s1">&#39;executables&#39;</span>
    <span class="n">_inventory_file_name</span> <span class="o">=</span> <span class="s1">&#39;ramble_inventory.json&#39;</span>
    <span class="n">_status_file_name</span> <span class="o">=</span> <span class="s1">&#39;ramble_status.json&#39;</span>
    <span class="n">_pipelines</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;analyze&#39;</span><span class="p">,</span> <span class="s1">&#39;archive&#39;</span><span class="p">,</span> <span class="s1">&#39;mirror&#39;</span><span class="p">,</span> <span class="s1">&#39;setup&#39;</span><span class="p">,</span> <span class="s1">&#39;pushtocache&#39;</span><span class="p">]</span>
    <span class="n">_language_classes</span> <span class="o">=</span> <span class="p">[</span><span class="n">ApplicationMeta</span><span class="p">,</span> <span class="n">SharedMeta</span><span class="p">]</span>

    <span class="c1">#: Lists of strings which contains GitHub usernames of attributes.</span>
    <span class="c1">#: Do not include @ here in order not to unnecessarily ping the users.</span>
    <span class="n">maintainers</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">tags</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">file_path</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">keywords</span> <span class="o">=</span> <span class="n">ramble</span><span class="o">.</span><span class="n">keywords</span><span class="o">.</span><span class="n">keywords</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_vars_are_expanded</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">expander</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">variables</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">experiment_set</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">internals</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">is_template</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">chained_experiments</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">chain_order</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">chain_prepend</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">chain_append</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">chain_commands</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_env_variable_sets</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">modifiers</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_modifier_instances</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_modifier_builtins</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_input_fetchers</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">hash_inventory</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s1">&#39;attributes&#39;</span><span class="p">:</span> <span class="p">[],</span>
            <span class="s1">&#39;inputs&#39;</span><span class="p">:</span> <span class="p">[],</span>
            <span class="s1">&#39;software&#39;</span><span class="p">:</span> <span class="p">[],</span>
            <span class="s1">&#39;templates&#39;</span><span class="p">:</span> <span class="p">[],</span>
        <span class="p">}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">experiment_hash</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_file_path</span> <span class="o">=</span> <span class="n">file_path</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">application_class</span> <span class="o">=</span> <span class="s1">&#39;ApplicationBase&#39;</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_verbosity</span> <span class="o">=</span> <span class="s1">&#39;short&#39;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_inject_required_builtins</span><span class="p">()</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">license_path</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">license_file</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">license_inc_name</span> <span class="o">=</span> <span class="s1">&#39;license.inc&#39;</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">build_phase_order</span><span class="p">()</span>

        <span class="n">ramble</span><span class="o">.</span><span class="n">util</span><span class="o">.</span><span class="n">directives</span><span class="o">.</span><span class="n">define_directive_methods</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>

<div class="viewcode-block" id="ApplicationBase.copy">
<a class="viewcode-back" href="../../ramble.html#ramble.application.ApplicationBase.copy">[docs]</a>
    <span class="k">def</span> <span class="nf">copy</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Deep copy an application instance&quot;&quot;&quot;</span>
        <span class="n">new_copy</span> <span class="o">=</span> <span class="nb">type</span><span class="p">(</span><span class="bp">self</span><span class="p">)(</span><span class="bp">self</span><span class="o">.</span><span class="n">_file_path</span><span class="p">)</span>

        <span class="n">new_copy</span><span class="o">.</span><span class="n">set_env_variable_sets</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_env_variable_sets</span><span class="o">.</span><span class="n">copy</span><span class="p">())</span>
        <span class="n">new_copy</span><span class="o">.</span><span class="n">set_variables</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">variables</span><span class="o">.</span><span class="n">copy</span><span class="p">(),</span> <span class="bp">self</span><span class="o">.</span><span class="n">experiment_set</span><span class="p">)</span>
        <span class="n">new_copy</span><span class="o">.</span><span class="n">set_internals</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">internals</span><span class="o">.</span><span class="n">copy</span><span class="p">())</span>
        <span class="n">new_copy</span><span class="o">.</span><span class="n">set_template</span><span class="p">(</span><span class="kc">False</span><span class="p">)</span>
        <span class="n">new_copy</span><span class="o">.</span><span class="n">set_chained_experiments</span><span class="p">(</span><span class="kc">None</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">new_copy</span></div>


<div class="viewcode-block" id="ApplicationBase.build_phase_order">
<a class="viewcode-back" href="../../ramble.html#ramble.application.ApplicationBase.build_phase_order">[docs]</a>
    <span class="k">def</span> <span class="nf">build_phase_order</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">pipeline</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_pipelines</span><span class="p">:</span>
            <span class="n">pipeline_phases</span> <span class="o">=</span> <span class="p">[]</span>

            <span class="k">if</span> <span class="n">pipeline</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">phase_definitions</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">phase_definitions</span><span class="p">[</span><span class="n">pipeline</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>

            <span class="c1"># Detect cycles</span>
            <span class="k">for</span> <span class="n">phase</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">phase_definitions</span><span class="p">[</span><span class="n">pipeline</span><span class="p">]</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>

                <span class="n">phase_stack</span> <span class="o">=</span> <span class="p">[</span><span class="n">phase</span><span class="p">]</span>
                <span class="n">phases_touched</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
                <span class="k">while</span> <span class="n">phase_stack</span><span class="p">:</span>
                    <span class="n">cur_phase</span> <span class="o">=</span> <span class="n">phase_stack</span><span class="o">.</span><span class="n">pop</span><span class="p">()</span>

                    <span class="k">if</span> <span class="n">cur_phase</span> <span class="ow">in</span> <span class="n">phases_touched</span><span class="p">:</span>
                        <span class="k">raise</span> <span class="n">PhaseCycleDetectedError</span><span class="p">(</span>
                            <span class="s1">&#39;Cycle detected when ordering phases in &#39;</span>
                            <span class="sa">f</span><span class="s1">&#39;application </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="se">\n</span><span class="s1">&#39;</span>
                            <span class="sa">f</span><span class="s1">&#39;Phase </span><span class="si">{</span><span class="n">phase</span><span class="si">}</span><span class="s1"> ultimately depends on itself.&#39;</span>
                        <span class="p">)</span>

                    <span class="k">for</span> <span class="n">dep_phase</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">phase_definitions</span><span class="p">[</span><span class="n">pipeline</span><span class="p">][</span><span class="n">cur_phase</span><span class="p">]:</span>
                        <span class="k">if</span> <span class="n">dep_phase</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">phase_definitions</span><span class="p">[</span><span class="n">pipeline</span><span class="p">]</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
                            <span class="k">raise</span> <span class="n">InvalidPhaseError</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;In application </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s1">, phase &#39;</span>
                                                    <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">dep_phase</span><span class="si">}</span><span class="s1"> is a dependency of &#39;</span>
                                                    <span class="sa">f</span><span class="s1">&#39;phase </span><span class="si">{</span><span class="n">phase</span><span class="si">}</span><span class="s1"> but is not defined.&#39;</span><span class="p">)</span>
                        <span class="n">phase_stack</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">dep_phase</span><span class="p">)</span>

            <span class="n">phases_to_add</span> <span class="o">=</span> <span class="p">[</span><span class="n">phase</span> <span class="k">for</span> <span class="n">phase</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">phase_definitions</span><span class="p">[</span><span class="n">pipeline</span><span class="p">]</span><span class="o">.</span><span class="n">keys</span><span class="p">()]</span>

            <span class="k">while</span> <span class="n">phases_to_add</span><span class="p">:</span>
                <span class="n">cur_phase</span> <span class="o">=</span> <span class="n">phases_to_add</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>

                <span class="n">earliest_idx</span> <span class="o">=</span> <span class="mi">0</span>
                <span class="k">for</span> <span class="n">dep_phase</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">phase_definitions</span><span class="p">[</span><span class="n">pipeline</span><span class="p">][</span><span class="n">cur_phase</span><span class="p">]:</span>
                    <span class="k">if</span> <span class="n">dep_phase</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">pipeline_phases</span><span class="p">:</span>
                        <span class="n">earliest_idx</span> <span class="o">=</span> <span class="kc">None</span>
                        <span class="k">break</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">earliest_idx</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">earliest_idx</span><span class="p">,</span> <span class="n">pipeline_phases</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">dep_phase</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>

                <span class="k">if</span> <span class="n">earliest_idx</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="n">phases_to_add</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">cur_phase</span><span class="p">)</span>
                <span class="k">elif</span> <span class="n">earliest_idx</span> <span class="o">==</span> <span class="mi">0</span> <span class="ow">or</span> <span class="n">earliest_idx</span> <span class="o">==</span> <span class="nb">len</span><span class="p">(</span><span class="n">pipeline_phases</span><span class="p">):</span>
                    <span class="n">pipeline_phases</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">cur_phase</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">pipeline_phases</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="n">earliest_idx</span><span class="p">,</span> <span class="n">cur_phase</span><span class="p">)</span>

            <span class="nb">setattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="sa">f</span><span class="s1">&#39;_</span><span class="si">{</span><span class="n">pipeline</span><span class="si">}</span><span class="s1">_phases&#39;</span><span class="p">,</span> <span class="n">pipeline_phases</span><span class="p">)</span></div>


    <span class="k">def</span> <span class="nf">_inject_required_builtins</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">required_builtins</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">builtin</span><span class="p">,</span> <span class="n">blt_conf</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">builtins</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="k">if</span> <span class="n">blt_conf</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">_builtin_required_key</span><span class="p">]:</span>
                <span class="n">required_builtins</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">builtin</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">workload</span><span class="p">,</span> <span class="n">wl_conf</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">workloads</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_workload_exec_key</span> <span class="ow">in</span> <span class="n">wl_conf</span><span class="p">:</span>
                <span class="c1"># Insert in reverse order, to make sure they are correctly ordered.</span>
                <span class="k">for</span> <span class="n">builtin</span> <span class="ow">in</span> <span class="nb">reversed</span><span class="p">(</span><span class="n">required_builtins</span><span class="p">):</span>
                    <span class="n">blt_conf</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">builtins</span><span class="p">[</span><span class="n">builtin</span><span class="p">]</span>
                    <span class="k">if</span> <span class="n">builtin</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">wl_conf</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">_workload_exec_key</span><span class="p">]:</span>
                        <span class="k">if</span> <span class="n">blt_conf</span><span class="p">[</span><span class="s1">&#39;injection_method&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;prepend&#39;</span><span class="p">:</span>
                            <span class="n">wl_conf</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">_workload_exec_key</span><span class="p">]</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">builtin</span><span class="p">)</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="n">wl_conf</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">_workload_exec_key</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">builtin</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_inject_required_modifier_builtins</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Inject builtins defined as required from each modifier into this</span>
<span class="sd">        application instance.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">modifiers</span> <span class="ow">or</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_modifier_instances</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">return</span>

        <span class="n">required_prepend_builtins</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">required_append_builtins</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="n">mod_regex</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="n">ramble</span><span class="o">.</span><span class="n">modifier</span><span class="o">.</span><span class="n">ModifierBase</span><span class="o">.</span><span class="n">_mod_builtin_regex</span> <span class="o">+</span>
                               <span class="sa">r</span><span class="s1">&#39;(?P&lt;func&gt;.*)&#39;</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">mod_inst</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_modifier_instances</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">builtin</span><span class="p">,</span> <span class="n">blt_conf</span> <span class="ow">in</span> <span class="n">mod_inst</span><span class="o">.</span><span class="n">builtins</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                <span class="k">if</span> <span class="n">blt_conf</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">_builtin_required_key</span><span class="p">]:</span>
                    <span class="n">blt_match</span> <span class="o">=</span> <span class="n">mod_regex</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="n">builtin</span><span class="p">)</span>

                    <span class="c1"># Each builtin should only be added once.</span>
                    <span class="n">added</span> <span class="o">=</span> <span class="kc">False</span>

                    <span class="k">if</span> <span class="n">blt_conf</span><span class="p">[</span><span class="s1">&#39;injection_method&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;prepend&#39;</span><span class="p">:</span>
                        <span class="k">if</span> <span class="n">builtin</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">required_prepend_builtins</span><span class="p">:</span>
                            <span class="n">required_prepend_builtins</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">builtin</span><span class="p">)</span>
                            <span class="n">added</span> <span class="o">=</span> <span class="kc">True</span>
                    <span class="k">else</span><span class="p">:</span>  <span class="c1"># Append</span>
                        <span class="k">if</span> <span class="n">builtin</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">required_append_builtins</span><span class="p">:</span>
                            <span class="n">required_append_builtins</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">builtin</span><span class="p">)</span>
                            <span class="n">added</span> <span class="o">=</span> <span class="kc">True</span>

                    <span class="c1"># Only update if the builtin was added to a list.</span>
                    <span class="k">if</span> <span class="n">added</span><span class="p">:</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">_modifier_builtins</span><span class="p">[</span><span class="n">builtin</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
                            <span class="s1">&#39;func&#39;</span><span class="p">:</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">mod_inst</span><span class="p">,</span>
                                            <span class="n">blt_match</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="s2">&quot;func&quot;</span><span class="p">))</span>
                        <span class="p">}</span>

        <span class="k">for</span> <span class="n">workload</span><span class="p">,</span> <span class="n">wl_conf</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">workloads</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_workload_exec_key</span> <span class="ow">in</span> <span class="n">wl_conf</span><span class="p">:</span>
                <span class="c1"># Insert prepend builtins in reverse order, to make sure they</span>
                <span class="c1"># are correctly ordered.</span>
                <span class="k">for</span> <span class="n">builtin</span> <span class="ow">in</span> <span class="nb">reversed</span><span class="p">(</span><span class="n">required_prepend_builtins</span><span class="p">):</span>
                    <span class="k">if</span> <span class="n">builtin</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">wl_conf</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">_workload_exec_key</span><span class="p">]:</span>
                        <span class="n">wl_conf</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">_workload_exec_key</span><span class="p">]</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">builtin</span><span class="p">)</span>

                <span class="c1"># Append builtins can be inserted in their correct order.</span>
                <span class="k">for</span> <span class="n">builtin</span> <span class="ow">in</span> <span class="n">required_append_builtins</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">builtin</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">wl_conf</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">_workload_exec_key</span><span class="p">]:</span>
                        <span class="n">wl_conf</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">_workload_exec_key</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">builtin</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_long_print</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">out_str</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">out_str</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">rucolor</span><span class="o">.</span><span class="n">section_title</span><span class="p">(</span><span class="s1">&#39;Application: &#39;</span><span class="p">)</span> <span class="o">+</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
        <span class="n">out_str</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>

        <span class="n">out_str</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">rucolor</span><span class="o">.</span><span class="n">section_title</span><span class="p">(</span><span class="s1">&#39;Description:</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">))</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="vm">__doc__</span><span class="p">:</span>
            <span class="n">out_str</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="se">\t</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="vm">__doc__</span><span class="si">}</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">out_str</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\t</span><span class="s1">None</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>

        <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s1">&#39;maintainers&#39;</span><span class="p">):</span>
            <span class="n">out_str</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
            <span class="n">out_str</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">rucolor</span><span class="o">.</span><span class="n">section_title</span><span class="p">(</span><span class="s2">&quot;Maintainers:</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">))</span>
            <span class="n">out_str</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">colified</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">maintainers</span><span class="p">,</span> <span class="n">tty</span><span class="o">=</span><span class="kc">True</span><span class="p">))</span>
            <span class="n">out_str</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>

        <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s1">&#39;tags&#39;</span><span class="p">):</span>
            <span class="n">out_str</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
            <span class="n">out_str</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">rucolor</span><span class="o">.</span><span class="n">section_title</span><span class="p">(</span><span class="s1">&#39;Tags:</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">))</span>
            <span class="n">out_str</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">colified</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">tags</span><span class="p">,</span> <span class="n">tty</span><span class="o">=</span><span class="kc">True</span><span class="p">))</span>
            <span class="n">out_str</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>

        <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s1">&#39;_setup_phases&#39;</span><span class="p">):</span>
            <span class="n">out_str</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
            <span class="n">out_str</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">rucolor</span><span class="o">.</span><span class="n">section_title</span><span class="p">(</span><span class="s1">&#39;Setup Pipeline Phases:</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">))</span>
            <span class="n">out_str</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">colified</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_setup_phases</span><span class="p">,</span> <span class="n">tty</span><span class="o">=</span><span class="kc">True</span><span class="p">))</span>

        <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s1">&#39;_analyze_phases&#39;</span><span class="p">):</span>
            <span class="n">out_str</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
            <span class="n">out_str</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">rucolor</span><span class="o">.</span><span class="n">section_title</span><span class="p">(</span><span class="s1">&#39;Analyze Pipeline Phases:</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">))</span>
            <span class="n">out_str</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">colified</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_analyze_phases</span><span class="p">,</span> <span class="n">tty</span><span class="o">=</span><span class="kc">True</span><span class="p">))</span>

        <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s1">&#39;workloads&#39;</span><span class="p">):</span>
            <span class="n">out_str</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">wl_name</span><span class="p">,</span> <span class="n">wl_conf</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">workloads</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                <span class="n">out_str</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">rucolor</span><span class="o">.</span><span class="n">section_title</span><span class="p">(</span><span class="s1">&#39;Workload:&#39;</span><span class="p">)</span> <span class="o">+</span> <span class="sa">f</span><span class="s1">&#39; </span><span class="si">{</span><span class="n">wl_name</span><span class="si">}</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
                <span class="n">out_str</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\t</span><span class="s1">&#39;</span> <span class="o">+</span> <span class="n">rucolor</span><span class="o">.</span><span class="n">nested_1</span><span class="p">(</span><span class="s1">&#39;Executables: &#39;</span><span class="p">)</span> <span class="o">+</span>
                               <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">wl_conf</span><span class="p">[</span><span class="s2">&quot;executables&quot;</span><span class="p">]</span><span class="si">}</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
                <span class="n">out_str</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\t</span><span class="s1">&#39;</span> <span class="o">+</span> <span class="n">rucolor</span><span class="o">.</span><span class="n">nested_1</span><span class="p">(</span><span class="s1">&#39;Inputs: &#39;</span><span class="p">)</span> <span class="o">+</span>
                               <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">wl_conf</span><span class="p">[</span><span class="s2">&quot;inputs&quot;</span><span class="p">]</span><span class="si">}</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>

                <span class="k">if</span> <span class="n">wl_name</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">workload_variables</span><span class="p">:</span>
                    <span class="n">out_str</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">rucolor</span><span class="o">.</span><span class="n">nested_1</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\t</span><span class="s1">Variables:</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">))</span>
                    <span class="k">for</span> <span class="n">var</span><span class="p">,</span> <span class="n">conf</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">workload_variables</span><span class="p">[</span><span class="n">wl_name</span><span class="p">]</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                        <span class="n">indent</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="se">\t\t</span><span class="s1">&#39;</span>

                        <span class="n">out_str</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">rucolor</span><span class="o">.</span><span class="n">nested_2</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">indent</span><span class="si">}{</span><span class="n">var</span><span class="si">}</span><span class="s1">:</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">))</span>
                        <span class="n">out_str</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">indent</span><span class="si">}</span><span class="se">\t</span><span class="s1">Description: </span><span class="si">{</span><span class="n">conf</span><span class="p">[</span><span class="s2">&quot;description&quot;</span><span class="p">]</span><span class="si">}</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
                        <span class="n">out_str</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">indent</span><span class="si">}</span><span class="se">\t</span><span class="s1">Default: </span><span class="si">{</span><span class="n">conf</span><span class="p">[</span><span class="s2">&quot;default&quot;</span><span class="p">]</span><span class="si">}</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
                        <span class="k">if</span> <span class="s1">&#39;values&#39;</span> <span class="ow">in</span> <span class="n">conf</span><span class="p">:</span>
                            <span class="n">out_str</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">indent</span><span class="si">}</span><span class="se">\t</span><span class="s1">Suggested Values: </span><span class="si">{</span><span class="n">conf</span><span class="p">[</span><span class="s2">&quot;values&quot;</span><span class="p">]</span><span class="si">}</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>

            <span class="n">out_str</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>

        <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s1">&#39;builtins&#39;</span><span class="p">):</span>
            <span class="n">out_str</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">rucolor</span><span class="o">.</span><span class="n">section_title</span><span class="p">(</span><span class="s1">&#39;Builtin Executables:</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">))</span>
            <span class="n">out_str</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\t</span><span class="s1">&#39;</span> <span class="o">+</span> <span class="n">colified</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">builtins</span><span class="o">.</span><span class="n">keys</span><span class="p">(),</span> <span class="n">tty</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">out_str</span>

<div class="viewcode-block" id="ApplicationBase.set_env_variable_sets">
<a class="viewcode-back" href="../../ramble.html#ramble.application.ApplicationBase.set_env_variable_sets">[docs]</a>
    <span class="k">def</span> <span class="nf">set_env_variable_sets</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">env_variable_sets</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Set internal reference to environment variable sets&quot;&quot;&quot;</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_env_variable_sets</span> <span class="o">=</span> <span class="n">env_variable_sets</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span></div>


<div class="viewcode-block" id="ApplicationBase.set_variables">
<a class="viewcode-back" href="../../ramble.html#ramble.application.ApplicationBase.set_variables">[docs]</a>
    <span class="k">def</span> <span class="nf">set_variables</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">variables</span><span class="p">,</span> <span class="n">experiment_set</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Set internal reference to variables</span>

<span class="sd">        Also, create an application specific expander class.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">variables</span> <span class="o">=</span> <span class="n">variables</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">experiment_set</span> <span class="o">=</span> <span class="n">experiment_set</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">expander</span> <span class="o">=</span> <span class="n">ramble</span><span class="o">.</span><span class="n">expander</span><span class="o">.</span><span class="n">Expander</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">variables</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">experiment_set</span><span class="p">)</span></div>


<div class="viewcode-block" id="ApplicationBase.set_internals">
<a class="viewcode-back" href="../../ramble.html#ramble.application.ApplicationBase.set_internals">[docs]</a>
    <span class="k">def</span> <span class="nf">set_internals</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">internals</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Set internal reference to application internals</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">internals</span> <span class="o">=</span> <span class="n">internals</span></div>


<div class="viewcode-block" id="ApplicationBase.set_template">
<a class="viewcode-back" href="../../ramble.html#ramble.application.ApplicationBase.set_template">[docs]</a>
    <span class="k">def</span> <span class="nf">set_template</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">is_template</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Set if this instance is a template or not&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">is_template</span> <span class="o">=</span> <span class="n">is_template</span></div>


<div class="viewcode-block" id="ApplicationBase.set_chained_experiments">
<a class="viewcode-back" href="../../ramble.html#ramble.application.ApplicationBase.set_chained_experiments">[docs]</a>
    <span class="k">def</span> <span class="nf">set_chained_experiments</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">chained_experiments</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Set chained experiments for this instance&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">chained_experiments</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">if</span> <span class="n">chained_experiments</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">chained_experiments</span> <span class="o">=</span> <span class="n">chained_experiments</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span></div>


<div class="viewcode-block" id="ApplicationBase.set_modifiers">
<a class="viewcode-back" href="../../ramble.html#ramble.application.ApplicationBase.set_modifiers">[docs]</a>
    <span class="k">def</span> <span class="nf">set_modifiers</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">modifiers</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Set modifiers for this instance&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">modifiers</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">modifiers</span> <span class="o">=</span> <span class="n">modifiers</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span></div>


<div class="viewcode-block" id="ApplicationBase.experiment_log_file">
<a class="viewcode-back" href="../../ramble.html#ramble.application.ApplicationBase.experiment_log_file">[docs]</a>
    <span class="k">def</span> <span class="nf">experiment_log_file</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">logs_dir</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Returns an experiment log file path for the given logs directory&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span>
            <span class="n">logs_dir</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">expander</span><span class="o">.</span><span class="n">experiment_namespace</span><span class="p">)</span> <span class="o">+</span> \
            <span class="s1">&#39;.out&#39;</span></div>


<div class="viewcode-block" id="ApplicationBase.get_pipeline_phases">
<a class="viewcode-back" href="../../ramble.html#ramble.application.ApplicationBase.get_pipeline_phases">[docs]</a>
    <span class="k">def</span> <span class="nf">get_pipeline_phases</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">pipeline</span><span class="p">,</span> <span class="n">phase_filters</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;*&#39;</span><span class="p">]):</span>
        <span class="k">if</span> <span class="n">pipeline</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_pipelines</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">die</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Requested pipeline </span><span class="si">{</span><span class="n">pipeline</span><span class="si">}</span><span class="s1"> is not valid.</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">,</span>
                       <span class="sa">f</span><span class="s1">&#39;</span><span class="se">\t</span><span class="s1">Available pipelinese are </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">_pipelines</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>

        <span class="n">phases</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
        <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="sa">f</span><span class="s1">&#39;_</span><span class="si">{</span><span class="n">pipeline</span><span class="si">}</span><span class="s1">_phases&#39;</span><span class="p">):</span>
            <span class="k">for</span> <span class="n">phase</span> <span class="ow">in</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="sa">f</span><span class="s1">&#39;_</span><span class="si">{</span><span class="n">pipeline</span><span class="si">}</span><span class="s1">_phases&#39;</span><span class="p">):</span>
                <span class="k">for</span> <span class="n">phase_filter</span> <span class="ow">in</span> <span class="n">phase_filters</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">fnmatch</span><span class="o">.</span><span class="n">fnmatch</span><span class="p">(</span><span class="n">phase</span><span class="p">,</span> <span class="n">phase_filter</span><span class="p">):</span>
                        <span class="n">phases</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">phase</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">die</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Pipeline </span><span class="si">{</span><span class="n">pipeline</span><span class="si">}</span><span class="s1"> is not defined in application </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>

        <span class="n">include_phase_deps</span> <span class="o">=</span> <span class="n">ramble</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;config:include_phase_dependencies&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">include_phase_deps</span><span class="p">:</span>
            <span class="n">phases_for_deps</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">phases</span><span class="p">)</span>
            <span class="k">while</span> <span class="n">phases_for_deps</span><span class="p">:</span>
                <span class="n">cur_phase</span> <span class="o">=</span> <span class="n">phases_for_deps</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
                <span class="k">for</span> <span class="n">dep_phase</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">phase_definitions</span><span class="p">[</span><span class="n">pipeline</span><span class="p">][</span><span class="n">cur_phase</span><span class="p">]:</span>
                    <span class="k">if</span> <span class="n">dep_phase</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">phases</span><span class="p">:</span>
                        <span class="n">phases_for_deps</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">dep_phase</span><span class="p">)</span>
                        <span class="n">phases</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">dep_phase</span><span class="p">)</span>

        <span class="k">return</span> <span class="p">[</span><span class="n">phase</span> <span class="k">for</span> <span class="n">phase</span> <span class="ow">in</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="sa">f</span><span class="s1">&#39;_</span><span class="si">{</span><span class="n">pipeline</span><span class="si">}</span><span class="s1">_phases&#39;</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">phase</span> <span class="ow">in</span> <span class="n">phases</span><span class="p">]</span></div>


    <span class="k">def</span> <span class="nf">_short_print</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">]</span>

    <span class="k">def</span> <span class="fm">__str__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_verbosity</span> <span class="o">==</span> <span class="s1">&#39;long&#39;</span><span class="p">:</span>
            <span class="k">return</span> <span class="s1">&#39;&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_long_print</span><span class="p">())</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">_verbosity</span> <span class="o">==</span> <span class="s1">&#39;short&#39;</span><span class="p">:</span>
            <span class="k">return</span> <span class="s1">&#39;&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_short_print</span><span class="p">())</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span>

<div class="viewcode-block" id="ApplicationBase.print_vars">
<a class="viewcode-back" href="../../ramble.html#ramble.application.ApplicationBase.print_vars">[docs]</a>
    <span class="k">def</span> <span class="nf">print_vars</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">header</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="n">vars_to_print</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">indent</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">):</span>
        <span class="n">print_vars</span> <span class="o">=</span> <span class="n">vars_to_print</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">print_vars</span><span class="p">:</span>
            <span class="n">print_vars</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">variables</span>

        <span class="n">color</span><span class="o">.</span><span class="n">cprint</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">indent</span><span class="si">}{</span><span class="n">header</span><span class="si">}</span><span class="s1">:&#39;</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">var</span><span class="p">,</span> <span class="n">val</span> <span class="ow">in</span> <span class="n">print_vars</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="n">expansion_var</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">expander</span><span class="o">.</span><span class="n">expansion_str</span><span class="p">(</span><span class="n">var</span><span class="p">)</span>
            <span class="n">expanded</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">expander</span><span class="o">.</span><span class="n">expand_var</span><span class="p">(</span><span class="n">expansion_var</span><span class="p">)</span>
            <span class="n">color</span><span class="o">.</span><span class="n">cprint</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">indent</span><span class="si">}</span><span class="s1">  </span><span class="si">{</span><span class="n">var</span><span class="si">}</span><span class="s1"> = </span><span class="si">{</span><span class="n">val</span><span class="si">}</span><span class="s1"> ==&gt; </span><span class="si">{</span><span class="n">expanded</span><span class="si">}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;@&#39;</span><span class="p">,</span> <span class="s1">&#39;@@&#39;</span><span class="p">))</span></div>


<div class="viewcode-block" id="ApplicationBase.print_internals">
<a class="viewcode-back" href="../../ramble.html#ramble.application.ApplicationBase.print_internals">[docs]</a>
    <span class="k">def</span> <span class="nf">print_internals</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">indent</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">):</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">internals</span><span class="p">:</span>
            <span class="k">return</span>

        <span class="k">if</span> <span class="n">namespace</span><span class="o">.</span><span class="n">custom_executables</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">internals</span><span class="p">:</span>
            <span class="n">header</span> <span class="o">=</span> <span class="n">rucolor</span><span class="o">.</span><span class="n">nested_4</span><span class="p">(</span><span class="s1">&#39;Custom Executables&#39;</span><span class="p">)</span>
            <span class="n">color</span><span class="o">.</span><span class="n">cprint</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">indent</span><span class="si">}{</span><span class="n">header</span><span class="si">}</span><span class="s1">:&#39;</span><span class="p">)</span>

            <span class="k">for</span> <span class="n">name</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">internals</span><span class="p">[</span><span class="n">namespace</span><span class="o">.</span><span class="n">custom_executables</span><span class="p">]:</span>
                <span class="n">color</span><span class="o">.</span><span class="n">cprint</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">indent</span><span class="si">}</span><span class="s1">  </span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">namespace</span><span class="o">.</span><span class="n">executables</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">internals</span><span class="p">:</span>
            <span class="n">header</span> <span class="o">=</span> <span class="n">rucolor</span><span class="o">.</span><span class="n">nested_4</span><span class="p">(</span><span class="s1">&#39;Executable Order&#39;</span><span class="p">)</span>
            <span class="n">color</span><span class="o">.</span><span class="n">cprint</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">indent</span><span class="si">}{</span><span class="n">header</span><span class="si">}</span><span class="s1">: </span><span class="si">{</span><span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">internals</span><span class="p">[</span><span class="n">namespace</span><span class="o">.</span><span class="n">executables</span><span class="p">])</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">namespace</span><span class="o">.</span><span class="n">executable_injection</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">internals</span><span class="p">:</span>
            <span class="n">header</span> <span class="o">=</span> <span class="n">rucolor</span><span class="o">.</span><span class="n">nested_4</span><span class="p">(</span><span class="s1">&#39;Executable Injection&#39;</span><span class="p">)</span>
            <span class="n">color</span><span class="o">.</span><span class="n">cprint</span><span class="p">(</span>
                <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">indent</span><span class="si">}{</span><span class="n">header</span><span class="si">}</span><span class="s1">: </span><span class="si">{</span><span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">internals</span><span class="p">[</span><span class="n">namespace</span><span class="o">.</span><span class="n">executable_injection</span><span class="p">])</span><span class="si">}</span><span class="s1">&#39;</span>
            <span class="p">)</span></div>


<div class="viewcode-block" id="ApplicationBase.print_chain_order">
<a class="viewcode-back" href="../../ramble.html#ramble.application.ApplicationBase.print_chain_order">[docs]</a>
    <span class="k">def</span> <span class="nf">print_chain_order</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">indent</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">):</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">chain_order</span><span class="p">:</span>
            <span class="k">return</span>

        <span class="n">header</span> <span class="o">=</span> <span class="n">rucolor</span><span class="o">.</span><span class="n">nested_4</span><span class="p">(</span><span class="s1">&#39;Experiment Chain&#39;</span><span class="p">)</span>
        <span class="n">color</span><span class="o">.</span><span class="n">cprint</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">indent</span><span class="si">}{</span><span class="n">header</span><span class="si">}</span><span class="s1">:&#39;</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">exp</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">chain_order</span><span class="p">:</span>
            <span class="n">color</span><span class="o">.</span><span class="n">cprint</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">indent</span><span class="si">}</span><span class="s1">- </span><span class="si">{</span><span class="n">exp</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span></div>


<div class="viewcode-block" id="ApplicationBase.format_doc">
<a class="viewcode-back" href="../../ramble.html#ramble.application.ApplicationBase.format_doc">[docs]</a>
    <span class="k">def</span> <span class="nf">format_doc</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Wrap doc string at 72 characters and format nicely&quot;&quot;&quot;</span>
        <span class="n">indent</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;indent&#39;</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="vm">__doc__</span><span class="p">:</span>
            <span class="k">return</span> <span class="s2">&quot;&quot;</span>

        <span class="n">doc</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;\s+&#39;</span><span class="p">,</span> <span class="s1">&#39; &#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="vm">__doc__</span><span class="p">)</span>
        <span class="n">lines</span> <span class="o">=</span> <span class="n">textwrap</span><span class="o">.</span><span class="n">wrap</span><span class="p">(</span><span class="n">doc</span><span class="p">,</span> <span class="mi">72</span><span class="p">)</span>
        <span class="n">results</span> <span class="o">=</span> <span class="n">six</span><span class="o">.</span><span class="n">StringIO</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">lines</span><span class="p">:</span>
            <span class="n">results</span><span class="o">.</span><span class="n">write</span><span class="p">((</span><span class="s2">&quot; &quot;</span> <span class="o">*</span> <span class="n">indent</span><span class="p">)</span> <span class="o">+</span> <span class="n">line</span> <span class="o">+</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">results</span><span class="o">.</span><span class="n">getvalue</span><span class="p">()</span></div>


    <span class="c1"># Phase execution helpers</span>
<div class="viewcode-block" id="ApplicationBase.run_phase">
<a class="viewcode-back" href="../../ramble.html#ramble.application.ApplicationBase.run_phase">[docs]</a>
    <span class="k">def</span> <span class="nf">run_phase</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">phase</span><span class="p">,</span> <span class="n">workspace</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Run a phase, by getting its function pointer&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">build_modifier_instances</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_inject_required_modifier_builtins</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">add_expand_vars</span><span class="p">(</span><span class="n">workspace</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_template</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s1"> is a template. Skipping phases&#39;</span><span class="p">)</span>
            <span class="k">return</span>

        <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="sa">f</span><span class="s1">&#39;_</span><span class="si">{</span><span class="n">phase</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">):</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">msg</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;  Executing phase </span><span class="si">{</span><span class="n">phase</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">mod_inst</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_modifier_instances</span><span class="p">:</span>
                <span class="n">mod_inst</span><span class="o">.</span><span class="n">run_phase_hook</span><span class="p">(</span><span class="n">workspace</span><span class="p">,</span> <span class="n">phase</span><span class="p">)</span>
            <span class="n">phase_func</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="sa">f</span><span class="s1">&#39;_</span><span class="si">{</span><span class="n">phase</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
            <span class="n">phase_func</span><span class="p">(</span><span class="n">workspace</span><span class="p">)</span></div>


<div class="viewcode-block" id="ApplicationBase.create_experiment_chain">
<a class="viewcode-back" href="../../ramble.html#ramble.application.ApplicationBase.create_experiment_chain">[docs]</a>
    <span class="k">def</span> <span class="nf">create_experiment_chain</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">workspace</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Create the necessary chained experiments for this instance</span>

<span class="sd">        This method determines which experiments need to be chained, grabs the</span>
<span class="sd">        base instance from the experiment set, creates a copy of it (with a</span>
<span class="sd">        unique name), injects the copy back into the experiment set,</span>
<span class="sd">        and builds an internal mapping from unique name to the chaining definition.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">chained_experiments</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_template</span><span class="p">:</span>
            <span class="k">return</span>

        <span class="c1"># Build initial stack. Uses a reversal of the current instance&#39;s</span>
        <span class="c1"># chained experiments</span>
        <span class="n">parent_namespace</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">expander</span><span class="o">.</span><span class="n">experiment_namespace</span>
        <span class="n">classes_in_stack</span> <span class="o">=</span> <span class="nb">set</span><span class="p">([</span><span class="bp">self</span><span class="p">])</span>
        <span class="n">chain_idx</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">chain_stack</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">exp</span> <span class="ow">in</span> <span class="nb">reversed</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">chained_experiments</span><span class="p">):</span>
            <span class="k">for</span> <span class="n">exp_name</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">experiment_set</span><span class="o">.</span><span class="n">search_primary_experiments</span><span class="p">(</span><span class="n">exp</span><span class="p">[</span><span class="s1">&#39;name&#39;</span><span class="p">]):</span>
                <span class="n">child_inst</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">experiment_set</span><span class="o">.</span><span class="n">get_experiment</span><span class="p">(</span><span class="n">exp_name</span><span class="p">)</span>

                <span class="k">if</span> <span class="n">child_inst</span> <span class="ow">in</span> <span class="n">classes_in_stack</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="n">ChainCycleDetectedError</span><span class="p">(</span><span class="s1">&#39;Cycle detected in experiment chain:</span><span class="se">\n</span><span class="s1">&#39;</span> <span class="o">+</span>
                                                  <span class="sa">f</span><span class="s1">&#39;    Primary experiment </span><span class="si">{</span><span class="n">parent_namespace</span><span class="si">}</span><span class="se">\n</span><span class="s1">&#39;</span> <span class="o">+</span>
                                                  <span class="sa">f</span><span class="s1">&#39;    Chained expeirment name: </span><span class="si">{</span><span class="n">exp_name</span><span class="si">}</span><span class="se">\n</span><span class="s1">&#39;</span> <span class="o">+</span>
                                                  <span class="sa">f</span><span class="s1">&#39;    Chain definition: </span><span class="si">{</span><span class="nb">str</span><span class="p">(</span><span class="n">exp</span><span class="p">)</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
                <span class="n">chain_stack</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">exp_name</span><span class="p">,</span> <span class="n">exp</span><span class="p">))</span>

        <span class="n">parent_run_dir</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">expander</span><span class="o">.</span><span class="n">expand_var</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">expander</span><span class="o">.</span><span class="n">expansion_str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">keywords</span><span class="o">.</span><span class="n">experiment_run_dir</span><span class="p">)</span>
        <span class="p">)</span>

        <span class="c1"># Continue until the stack is empty</span>
        <span class="k">while</span> <span class="nb">len</span><span class="p">(</span><span class="n">chain_stack</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">cur_exp_name</span> <span class="o">=</span> <span class="n">chain_stack</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">cur_exp_def</span> <span class="o">=</span> <span class="n">chain_stack</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span>

            <span class="c1"># Perform basic validation on the chained experiment definition</span>
            <span class="k">if</span> <span class="s1">&#39;name&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">cur_exp_def</span><span class="p">:</span>
                <span class="k">raise</span> <span class="n">InvalidChainError</span><span class="p">(</span><span class="s1">&#39;Invalid experiment chain defined:</span><span class="se">\n</span><span class="s1">&#39;</span> <span class="o">+</span>
                                        <span class="sa">f</span><span class="s1">&#39;    Primary experiment </span><span class="si">{</span><span class="n">parent_namespace</span><span class="si">}</span><span class="se">\n</span><span class="s1">&#39;</span> <span class="o">+</span>
                                        <span class="sa">f</span><span class="s1">&#39;    Chain definition: </span><span class="si">{</span><span class="nb">str</span><span class="p">(</span><span class="n">exp</span><span class="p">)</span><span class="si">}</span><span class="se">\n</span><span class="s1">&#39;</span> <span class="o">+</span>
                                        <span class="s1">&#39;    &quot;name&quot; keyword must be defined&#39;</span><span class="p">)</span>

            <span class="k">if</span> <span class="s1">&#39;order&#39;</span> <span class="ow">in</span> <span class="n">cur_exp_def</span><span class="p">:</span>
                <span class="n">possible_orders</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;after_chain&#39;</span><span class="p">,</span> <span class="s1">&#39;after_root&#39;</span><span class="p">,</span> <span class="s1">&#39;before_chain&#39;</span><span class="p">,</span> <span class="s1">&#39;before_root&#39;</span><span class="p">]</span>
                <span class="k">if</span> <span class="n">cur_exp_def</span><span class="p">[</span><span class="s1">&#39;order&#39;</span><span class="p">]</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">possible_orders</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="n">InvalidChainError</span><span class="p">(</span><span class="s1">&#39;Invalid experiment chain defined:</span><span class="se">\n</span><span class="s1">&#39;</span> <span class="o">+</span>
                                            <span class="sa">f</span><span class="s1">&#39;    Primary experiment </span><span class="si">{</span><span class="n">parent_namespace</span><span class="si">}</span><span class="se">\n</span><span class="s1">&#39;</span> <span class="o">+</span>
                                            <span class="sa">f</span><span class="s1">&#39;    Chain definition: </span><span class="si">{</span><span class="nb">str</span><span class="p">(</span><span class="n">exp</span><span class="p">)</span><span class="si">}</span><span class="se">\n</span><span class="s1">&#39;</span> <span class="o">+</span>
                                            <span class="s1">&#39;    Optional keyword &quot;order&quot; must &#39;</span> <span class="o">+</span>
                                            <span class="sa">f</span><span class="s1">&#39;be one of </span><span class="si">{</span><span class="nb">str</span><span class="p">(</span><span class="n">possible_orders</span><span class="p">)</span><span class="si">}</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>

            <span class="k">if</span> <span class="s1">&#39;command&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">cur_exp_def</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
                <span class="k">raise</span> <span class="n">InvalidChainError</span><span class="p">(</span><span class="s1">&#39;Invalid experiment chain defined:</span><span class="se">\n</span><span class="s1">&#39;</span> <span class="o">+</span>
                                        <span class="sa">f</span><span class="s1">&#39;    Primary experiment </span><span class="si">{</span><span class="n">parent_namespace</span><span class="si">}</span><span class="se">\n</span><span class="s1">&#39;</span> <span class="o">+</span>
                                        <span class="sa">f</span><span class="s1">&#39;    Chain definition: </span><span class="si">{</span><span class="nb">str</span><span class="p">(</span><span class="n">exp</span><span class="p">)</span><span class="si">}</span><span class="se">\n</span><span class="s1">&#39;</span> <span class="o">+</span>
                                        <span class="s1">&#39;    &quot;command&quot; keyword must be defined&#39;</span><span class="p">)</span>

            <span class="k">if</span> <span class="s1">&#39;variables&#39;</span> <span class="ow">in</span> <span class="n">cur_exp_def</span><span class="p">:</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">cur_exp_def</span><span class="p">[</span><span class="s1">&#39;variables&#39;</span><span class="p">],</span> <span class="nb">dict</span><span class="p">):</span>
                    <span class="k">raise</span> <span class="n">InvalidChainError</span><span class="p">(</span><span class="s1">&#39;Invalid experiment chain defined:</span><span class="se">\n</span><span class="s1">&#39;</span> <span class="o">+</span>
                                            <span class="sa">f</span><span class="s1">&#39;    Primary experiment </span><span class="si">{</span><span class="n">parent_namespace</span><span class="si">}</span><span class="se">\n</span><span class="s1">&#39;</span> <span class="o">+</span>
                                            <span class="sa">f</span><span class="s1">&#39;    Chain definition: </span><span class="si">{</span><span class="nb">str</span><span class="p">(</span><span class="n">exp</span><span class="p">)</span><span class="si">}</span><span class="se">\n</span><span class="s1">&#39;</span> <span class="o">+</span>
                                            <span class="s1">&#39;    Optional keyword &quot;variables&quot; &#39;</span> <span class="o">+</span>
                                            <span class="s1">&#39;must be a dictionary&#39;</span><span class="p">)</span>

            <span class="n">base_inst</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">experiment_set</span><span class="o">.</span><span class="n">get_experiment</span><span class="p">(</span><span class="n">cur_exp_name</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">base_inst</span> <span class="ow">in</span> <span class="n">classes_in_stack</span><span class="p">:</span>
                <span class="n">chain_stack</span><span class="o">.</span><span class="n">pop</span><span class="p">()</span>
                <span class="n">classes_in_stack</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">base_inst</span><span class="p">)</span>

                <span class="n">order</span> <span class="o">=</span> <span class="s1">&#39;after_root&#39;</span>
                <span class="k">if</span> <span class="s1">&#39;order&#39;</span> <span class="ow">in</span> <span class="n">cur_exp_def</span><span class="p">:</span>
                    <span class="n">order</span> <span class="o">=</span> <span class="n">cur_exp_def</span><span class="p">[</span><span class="s1">&#39;order&#39;</span><span class="p">]</span>

                <span class="n">chained_name</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">chain_idx</span><span class="si">}</span><span class="s1">.</span><span class="si">{</span><span class="n">cur_exp_name</span><span class="si">}</span><span class="s1">&#39;</span>
                <span class="n">new_name</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">parent_namespace</span><span class="si">}</span><span class="s1">.chain.</span><span class="si">{</span><span class="n">chained_name</span><span class="si">}</span><span class="s1">&#39;</span>

                <span class="n">new_run_dir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">parent_run_dir</span><span class="p">,</span>
                                           <span class="n">namespace</span><span class="o">.</span><span class="n">chained_experiments</span><span class="p">,</span> <span class="n">chained_name</span><span class="p">)</span>

                <span class="k">if</span> <span class="n">order</span> <span class="o">==</span> <span class="s1">&#39;before_chain&#39;</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">chain_prepend</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">new_name</span><span class="p">)</span>
                <span class="k">elif</span> <span class="n">order</span> <span class="o">==</span> <span class="s1">&#39;before_root&#39;</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">chain_prepend</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">new_name</span><span class="p">)</span>
                <span class="k">elif</span> <span class="n">order</span> <span class="o">==</span> <span class="s1">&#39;after_root&#39;</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">chain_append</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">new_name</span><span class="p">)</span>
                <span class="k">elif</span> <span class="n">order</span> <span class="o">==</span> <span class="s1">&#39;after_chain&#39;</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">chain_append</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">new_name</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">chain_commands</span><span class="p">[</span><span class="n">new_name</span><span class="p">]</span> <span class="o">=</span> <span class="n">cur_exp_def</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">keywords</span><span class="o">.</span><span class="n">command</span><span class="p">]</span>

                <span class="c1"># Skip editing the new instance if the base_inst doesn&#39;t work</span>
                <span class="c1"># This happens if the originating command is `workspace info`</span>
                <span class="c1"># The printing experiment set doesn&#39;t have access to all</span>
                <span class="c1"># of the experiment, so the base_inst command above</span>
                <span class="c1"># doesn&#39;t get an application instance.</span>
                <span class="k">if</span> <span class="n">base_inst</span><span class="p">:</span>
                    <span class="n">new_inst</span> <span class="o">=</span> <span class="n">base_inst</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>

                    <span class="k">if</span> <span class="n">namespace</span><span class="o">.</span><span class="n">variables</span> <span class="ow">in</span> <span class="n">cur_exp_def</span><span class="p">:</span>
                        <span class="k">for</span> <span class="n">var</span><span class="p">,</span> <span class="n">val</span> <span class="ow">in</span> <span class="n">cur_exp_def</span><span class="p">[</span><span class="n">namespace</span><span class="o">.</span><span class="n">variables</span><span class="p">]</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                            <span class="n">new_inst</span><span class="o">.</span><span class="n">variables</span><span class="p">[</span><span class="n">var</span><span class="p">]</span> <span class="o">=</span> <span class="n">val</span>

                    <span class="n">new_inst</span><span class="o">.</span><span class="n">expander</span><span class="o">.</span><span class="n">_experiment_namespace</span> <span class="o">=</span> <span class="n">new_name</span>
                    <span class="n">new_inst</span><span class="o">.</span><span class="n">variables</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">keywords</span><span class="o">.</span><span class="n">experiment_run_dir</span><span class="p">]</span> <span class="o">=</span> <span class="n">new_run_dir</span>
                    <span class="n">new_inst</span><span class="o">.</span><span class="n">variables</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">keywords</span><span class="o">.</span><span class="n">experiment_name</span><span class="p">]</span> <span class="o">=</span> <span class="n">new_name</span>
                    <span class="n">new_inst</span><span class="o">.</span><span class="n">variables</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">keywords</span><span class="o">.</span><span class="n">experiment_index</span><span class="p">]</span> <span class="o">=</span> \
                        <span class="bp">self</span><span class="o">.</span><span class="n">expander</span><span class="o">.</span><span class="n">expand_var_name</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">keywords</span><span class="o">.</span><span class="n">experiment_index</span><span class="p">)</span>

                    <span class="c1"># Expand the chained experiment vars, so we can build the execution command</span>
                    <span class="n">new_inst</span><span class="o">.</span><span class="n">add_expand_vars</span><span class="p">(</span><span class="n">workspace</span><span class="p">)</span>
                    <span class="n">chain_cmd</span> <span class="o">=</span> <span class="n">new_inst</span><span class="o">.</span><span class="n">expander</span><span class="o">.</span><span class="n">expand_var</span><span class="p">(</span><span class="n">cur_exp_def</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">keywords</span><span class="o">.</span><span class="n">command</span><span class="p">])</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">chain_commands</span><span class="p">[</span><span class="n">new_name</span><span class="p">]</span> <span class="o">=</span> <span class="n">chain_cmd</span>
                    <span class="n">cur_exp_def</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">keywords</span><span class="o">.</span><span class="n">command</span><span class="p">]</span> <span class="o">=</span> <span class="n">chain_cmd</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">experiment_set</span><span class="o">.</span><span class="n">add_chained_experiment</span><span class="p">(</span><span class="n">new_name</span><span class="p">,</span> <span class="n">new_inst</span><span class="p">)</span>

                <span class="n">chain_idx</span> <span class="o">+=</span> <span class="mi">1</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="c1"># Avoid cycles, from children</span>
                <span class="k">if</span> <span class="n">base_inst</span> <span class="ow">in</span> <span class="n">classes_in_stack</span><span class="p">:</span>
                    <span class="n">chain_stack</span><span class="o">.</span><span class="n">pop</span><span class="p">()</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">base_inst</span><span class="o">.</span><span class="n">chained_experiments</span><span class="p">:</span>
                        <span class="k">for</span> <span class="n">exp</span> <span class="ow">in</span> <span class="nb">reversed</span><span class="p">(</span><span class="n">base_inst</span><span class="o">.</span><span class="n">chained_experiments</span><span class="p">):</span>
                            <span class="k">for</span> <span class="n">exp_name</span> <span class="ow">in</span> \
                                    <span class="bp">self</span><span class="o">.</span><span class="n">experiment_set</span><span class="o">.</span><span class="n">search_primary_experiments</span><span class="p">(</span><span class="n">exp</span><span class="p">[</span><span class="s1">&#39;name&#39;</span><span class="p">]):</span>
                                <span class="n">child_inst</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">experiment_set</span><span class="o">.</span><span class="n">get_experiment</span><span class="p">(</span><span class="n">exp_name</span><span class="p">)</span>
                                <span class="k">if</span> <span class="n">child_inst</span> <span class="ow">in</span> <span class="n">classes_in_stack</span><span class="p">:</span>
                                    <span class="k">raise</span> <span class="n">ChainCycleDetectedError</span><span class="p">(</span><span class="s1">&#39;Cycle detected in &#39;</span> <span class="o">+</span>
                                                                  <span class="s1">&#39;experiment chain:</span><span class="se">\n</span><span class="s1">&#39;</span> <span class="o">+</span>
                                                                  <span class="s1">&#39;    Primary experiment &#39;</span> <span class="o">+</span>
                                                                  <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">parent_namespace</span><span class="si">}</span><span class="se">\n</span><span class="s1">&#39;</span> <span class="o">+</span>
                                                                  <span class="s1">&#39;    Chained expeirment name: &#39;</span> <span class="o">+</span>
                                                                  <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">cur_exp_name</span><span class="si">}</span><span class="se">\n</span><span class="s1">&#39;</span> <span class="o">+</span>
                                                                  <span class="s1">&#39;    Chain definition: &#39;</span> <span class="o">+</span>
                                                                  <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="nb">str</span><span class="p">(</span><span class="n">cur_exp_def</span><span class="p">)</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>

                                <span class="n">chain_stack</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">exp_name</span><span class="p">,</span> <span class="n">exp</span><span class="p">))</span>
                    <span class="n">classes_in_stack</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">base_inst</span><span class="p">)</span>

        <span class="c1"># Create the final chain order</span>
        <span class="k">for</span> <span class="n">exp</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">chain_prepend</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">chain_order</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">exp</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">chain_order</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">expander</span><span class="o">.</span><span class="n">experiment_namespace</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">exp</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">chain_append</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">chain_order</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">exp</span><span class="p">)</span>

        <span class="c1"># Inject the chain order into the children experiments</span>
        <span class="k">for</span> <span class="n">exp</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">chain_prepend</span><span class="p">:</span>
            <span class="n">exp_inst</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">experiment_set</span><span class="o">.</span><span class="n">get_experiment</span><span class="p">(</span><span class="n">exp</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">exp_inst</span><span class="p">:</span>
                <span class="n">exp_inst</span><span class="o">.</span><span class="n">chain_order</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">chain_order</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>

        <span class="k">for</span> <span class="n">exp</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">chain_append</span><span class="p">:</span>
            <span class="n">exp_inst</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">experiment_set</span><span class="o">.</span><span class="n">get_experiment</span><span class="p">(</span><span class="n">exp</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">exp_inst</span><span class="p">:</span>
                <span class="n">exp_inst</span><span class="o">.</span><span class="n">chain_order</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">chain_order</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span></div>


<div class="viewcode-block" id="ApplicationBase.build_modifier_instances">
<a class="viewcode-back" href="../../ramble.html#ramble.application.ApplicationBase.build_modifier_instances">[docs]</a>
    <span class="k">def</span> <span class="nf">build_modifier_instances</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Built a map of modifier names to modifier instances needed for this</span>
<span class="sd">           application instance</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">modifiers</span><span class="p">:</span>
            <span class="k">return</span>

        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_modifier_instances</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">return</span>

        <span class="n">mod_type</span> <span class="o">=</span> <span class="n">ramble</span><span class="o">.</span><span class="n">repository</span><span class="o">.</span><span class="n">ObjectTypes</span><span class="o">.</span><span class="n">modifiers</span>

        <span class="k">for</span> <span class="n">mod</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">modifiers</span><span class="p">:</span>
            <span class="n">mod_inst</span> <span class="o">=</span> <span class="n">ramble</span><span class="o">.</span><span class="n">repository</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">mod</span><span class="p">[</span><span class="s1">&#39;name&#39;</span><span class="p">],</span> <span class="n">mod_type</span><span class="p">)</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>

            <span class="k">if</span> <span class="s1">&#39;on_executable&#39;</span> <span class="ow">in</span> <span class="n">mod</span><span class="p">:</span>
                <span class="n">mod_inst</span><span class="o">.</span><span class="n">set_on_executables</span><span class="p">(</span><span class="n">mod</span><span class="p">[</span><span class="s1">&#39;on_executable&#39;</span><span class="p">])</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">mod_inst</span><span class="o">.</span><span class="n">set_on_executables</span><span class="p">(</span><span class="kc">None</span><span class="p">)</span>

            <span class="k">if</span> <span class="s1">&#39;mode&#39;</span> <span class="ow">in</span> <span class="n">mod</span><span class="p">:</span>
                <span class="n">mod_inst</span><span class="o">.</span><span class="n">set_usage_mode</span><span class="p">(</span><span class="n">mod</span><span class="p">[</span><span class="s1">&#39;mode&#39;</span><span class="p">])</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">mod_inst</span><span class="o">.</span><span class="n">set_usage_mode</span><span class="p">(</span><span class="kc">None</span><span class="p">)</span>

            <span class="n">mod_inst</span><span class="o">.</span><span class="n">inherit_from_application</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">_modifier_instances</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">mod_inst</span><span class="p">)</span>

            <span class="c1"># Add this modifiers required variables for validation</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">keywords</span><span class="o">.</span><span class="n">update_keys</span><span class="p">(</span><span class="n">mod_inst</span><span class="o">.</span><span class="n">required_vars</span><span class="p">)</span>

        <span class="c1"># Validate the new modifiers variables exist</span>
        <span class="c1"># (note: the base ramble variables are checked earlier too)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">keywords</span><span class="o">.</span><span class="n">check_required_keys</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">variables</span><span class="p">)</span></div>


    <span class="k">def</span> <span class="nf">_get_executables</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Return executables for add_expand_vars&quot;&quot;&quot;</span>

        <span class="n">executables</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">workloads</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">expander</span><span class="o">.</span><span class="n">workload_name</span><span class="p">][</span><span class="s1">&#39;executables&#39;</span><span class="p">]</span>

        <span class="c1"># Use yaml defined executable order, if defined</span>
        <span class="k">if</span> <span class="n">namespace</span><span class="o">.</span><span class="n">executables</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">internals</span><span class="p">:</span>
            <span class="n">executables</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">internals</span><span class="p">[</span><span class="n">namespace</span><span class="o">.</span><span class="n">executables</span><span class="p">]</span>

        <span class="c1"># Define custom executables</span>
        <span class="k">if</span> <span class="n">namespace</span><span class="o">.</span><span class="n">custom_executables</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">internals</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">name</span><span class="p">,</span> <span class="n">conf</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">internals</span><span class="p">[</span><span class="n">namespace</span><span class="o">.</span><span class="n">custom_executables</span><span class="p">]</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">executables</span><span class="p">[</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="n">ramble</span><span class="o">.</span><span class="n">util</span><span class="o">.</span><span class="n">executable</span><span class="o">.</span><span class="n">CommandExecutable</span><span class="p">(</span>
                    <span class="n">name</span><span class="o">=</span><span class="n">name</span><span class="p">,</span>
                    <span class="o">**</span><span class="n">conf</span>
                <span class="p">)</span>

        <span class="c1"># Perform executable injection</span>
        <span class="k">if</span> <span class="n">namespace</span><span class="o">.</span><span class="n">executable_injection</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">internals</span><span class="p">:</span>

            <span class="n">supported_orders</span> <span class="o">=</span> <span class="n">enum</span><span class="o">.</span><span class="n">Enum</span><span class="p">(</span><span class="s1">&#39;supported_orders&#39;</span><span class="p">,</span> <span class="p">[</span><span class="s1">&#39;before&#39;</span><span class="p">,</span> <span class="s1">&#39;after&#39;</span><span class="p">])</span>

            <span class="c1"># Order can be &#39;before&#39; or &#39;after.</span>
            <span class="c1"># If `relative_to` is not set, then before adds to be the beginning of the list</span>
            <span class="c1">#                  and after (default) adds to the end of the list</span>
            <span class="c1"># If `relative_to` IS set, then before adds before the first instance of</span>
            <span class="c1">#                  the executable in the list</span>
            <span class="c1">#                  and after (default) adds after the last instance of the</span>
            <span class="c1">#                  executable in the list</span>
            <span class="c1"># If `relative_to` is set, and the executable name is not found, raise a fatal error.</span>
            <span class="k">for</span> <span class="n">exec_injection</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">internals</span><span class="p">[</span><span class="n">namespace</span><span class="o">.</span><span class="n">executable_injection</span><span class="p">]:</span>
                <span class="n">exec_name</span> <span class="o">=</span> <span class="n">exec_injection</span><span class="p">[</span><span class="s1">&#39;name&#39;</span><span class="p">]</span>

                <span class="n">injection_order</span> <span class="o">=</span> <span class="n">supported_orders</span><span class="o">.</span><span class="n">after</span>
                <span class="k">if</span> <span class="s1">&#39;order&#39;</span> <span class="ow">in</span> <span class="n">exec_injection</span><span class="p">:</span>
                    <span class="k">if</span> <span class="ow">not</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">supported_orders</span><span class="p">,</span> <span class="n">exec_injection</span><span class="p">[</span><span class="s1">&#39;order&#39;</span><span class="p">]):</span>
                        <span class="n">logger</span><span class="o">.</span><span class="n">die</span><span class="p">(</span><span class="s1">&#39;In experiment &#39;</span>
                                   <span class="sa">f</span><span class="s1">&#39;&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">expander</span><span class="o">.</span><span class="n">experiment_namespace</span><span class="si">}</span><span class="s1">&quot; &#39;</span>
                                   <span class="sa">f</span><span class="s1">&#39;injection order of executable &quot;</span><span class="si">{</span><span class="n">exec_name</span><span class="si">}</span><span class="s1">&quot; is set to an &#39;</span>
                                   <span class="sa">f</span><span class="s1">&#39;invalid value of &quot;</span><span class="si">{</span><span class="n">injection_order</span><span class="si">}</span><span class="s1">&quot;.</span><span class="se">\n</span><span class="s1">&#39;</span>
                                   <span class="sa">f</span><span class="s1">&#39;Valid values are </span><span class="si">{</span><span class="n">supported_orders</span><span class="si">}</span><span class="s1">.&#39;</span><span class="p">)</span>

                    <span class="n">injection_order</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">supported_orders</span><span class="p">,</span> <span class="n">exec_injection</span><span class="p">[</span><span class="s1">&#39;order&#39;</span><span class="p">])</span>

                <span class="n">relative</span> <span class="o">=</span> <span class="kc">None</span>
                <span class="k">if</span> <span class="s1">&#39;relative_to&#39;</span> <span class="ow">in</span> <span class="n">exec_injection</span><span class="p">:</span>
                    <span class="n">relative</span> <span class="o">=</span> <span class="n">exec_injection</span><span class="p">[</span><span class="s1">&#39;relative_to&#39;</span><span class="p">]</span>

                <span class="k">if</span> <span class="n">exec_name</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">executables</span><span class="p">:</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">die</span><span class="p">(</span><span class="s1">&#39;In experiment &#39;</span>
                               <span class="sa">f</span><span class="s1">&#39;&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">expander</span><span class="o">.</span><span class="n">experiment_namespace</span><span class="si">}</span><span class="s1">&quot; &#39;</span>
                               <span class="sa">f</span><span class="s1">&#39;attempting to inject a non existing executable &quot;</span><span class="si">{</span><span class="n">exec_name</span><span class="si">}</span><span class="s1">&quot;.&#39;</span><span class="p">)</span>

                <span class="k">if</span> <span class="n">relative</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">relative</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">executables</span><span class="p">:</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">die</span><span class="p">(</span><span class="s1">&#39;In experiment &#39;</span>
                               <span class="sa">f</span><span class="s1">&#39;&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">expander</span><span class="o">.</span><span class="n">experiment_namespace</span><span class="si">}</span><span class="s1">&quot; &#39;</span>
                               <span class="sa">f</span><span class="s1">&#39;attempting to inject executable &quot;</span><span class="si">{</span><span class="n">exec_name</span><span class="si">}</span><span class="s1">&quot; &#39;</span>
                               <span class="sa">f</span><span class="s1">&#39;relative to a non existing executable &quot;</span><span class="si">{</span><span class="n">relative</span><span class="si">}</span><span class="s1">&quot;.&#39;</span><span class="p">)</span>

                <span class="k">if</span> <span class="n">relative</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">injection_order</span> <span class="o">==</span> <span class="n">supported_orders</span><span class="o">.</span><span class="n">before</span><span class="p">:</span>
                        <span class="n">executables</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">exec_name</span><span class="p">)</span>
                    <span class="k">elif</span> <span class="n">injection_order</span> <span class="o">==</span> <span class="n">supported_orders</span><span class="o">.</span><span class="n">after</span><span class="p">:</span>
                        <span class="n">executables</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">exec_name</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>

                    <span class="n">found</span> <span class="o">=</span> <span class="kc">False</span>
                    <span class="k">if</span> <span class="n">injection_order</span> <span class="o">==</span> <span class="n">supported_orders</span><span class="o">.</span><span class="n">before</span><span class="p">:</span>
                        <span class="n">relative_index</span> <span class="o">=</span> <span class="mi">0</span>
                        <span class="n">increment</span> <span class="o">=</span> <span class="mi">1</span>
                    <span class="k">elif</span> <span class="n">injection_order</span> <span class="o">==</span> <span class="n">supported_orders</span><span class="o">.</span><span class="n">after</span><span class="p">:</span>
                        <span class="n">relative_index</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">executables</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span>
                        <span class="n">increment</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>

                    <span class="k">while</span> <span class="ow">not</span> <span class="n">found</span> <span class="ow">and</span> <span class="n">relative_index</span> <span class="o">&lt;=</span> <span class="nb">len</span><span class="p">(</span><span class="n">executables</span><span class="p">)</span> \
                            <span class="ow">and</span> <span class="n">relative_index</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">:</span>
                        <span class="k">if</span> <span class="n">executables</span><span class="p">[</span><span class="n">relative_index</span><span class="p">]</span> <span class="o">==</span> <span class="n">relative</span><span class="p">:</span>
                            <span class="n">found</span> <span class="o">=</span> <span class="kc">True</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="n">relative_index</span> <span class="o">+=</span> <span class="n">increment</span>

                    <span class="k">if</span> <span class="n">injection_order</span> <span class="o">==</span> <span class="n">supported_orders</span><span class="o">.</span><span class="n">before</span><span class="p">:</span>
                        <span class="n">injection_index</span> <span class="o">=</span> <span class="n">relative_index</span>
                    <span class="k">elif</span> <span class="n">injection_order</span> <span class="o">==</span> <span class="n">supported_orders</span><span class="o">.</span><span class="n">after</span><span class="p">:</span>
                        <span class="n">injection_index</span> <span class="o">=</span> <span class="n">relative_index</span> <span class="o">+</span> <span class="mi">1</span>

                    <span class="n">executables</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="n">injection_index</span><span class="p">,</span> <span class="n">exec_name</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">executables</span>

    <span class="k">def</span> <span class="nf">_set_input_path</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Put input_path into self.variables[input_file] for add_expand_vars&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_inputs_and_fetchers</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">expander</span><span class="o">.</span><span class="n">workload_name</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">input_file</span><span class="p">,</span> <span class="n">input_conf</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_input_fetchers</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="n">input_vars</span> <span class="o">=</span> <span class="p">{</span><span class="bp">self</span><span class="o">.</span><span class="n">keywords</span><span class="o">.</span><span class="n">input_name</span><span class="p">:</span> <span class="n">input_conf</span><span class="p">[</span><span class="s1">&#39;input_name&#39;</span><span class="p">]}</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">input_conf</span><span class="p">[</span><span class="s1">&#39;expand&#39;</span><span class="p">]:</span>
                <span class="n">input_vars</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">keywords</span><span class="o">.</span><span class="n">input_name</span><span class="p">]</span> <span class="o">=</span> <span class="n">input_file</span>
            <span class="n">input_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">expander</span><span class="o">.</span><span class="n">workload_input_dir</span><span class="p">,</span>
                                      <span class="bp">self</span><span class="o">.</span><span class="n">expander</span><span class="o">.</span><span class="n">expand_var</span><span class="p">(</span><span class="n">input_conf</span><span class="p">[</span><span class="s1">&#39;target_dir&#39;</span><span class="p">],</span>
                                                               <span class="n">extra_vars</span><span class="o">=</span><span class="n">input_vars</span><span class="p">))</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">variables</span><span class="p">[</span><span class="n">input_conf</span><span class="p">[</span><span class="s1">&#39;input_name&#39;</span><span class="p">]]</span> <span class="o">=</span> <span class="n">input_path</span>

    <span class="k">def</span> <span class="nf">_set_default_experiment_variables</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Set default experiment variables (for add_expand_vars),</span>
<span class="sd">        if they haven&#39;t been set already&quot;&quot;&quot;</span>
        <span class="c1"># Set default experiment variables, if they haven&#39;t been set already</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">expander</span><span class="o">.</span><span class="n">workload_name</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">workload_variables</span><span class="p">:</span>
            <span class="n">wl_vars</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">workload_variables</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">expander</span><span class="o">.</span><span class="n">workload_name</span><span class="p">]</span>

            <span class="k">for</span> <span class="n">var</span><span class="p">,</span> <span class="n">conf</span> <span class="ow">in</span> <span class="n">wl_vars</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                <span class="k">if</span> <span class="n">var</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">variables</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">variables</span><span class="p">[</span><span class="n">var</span><span class="p">]</span> <span class="o">=</span> <span class="n">conf</span><span class="p">[</span><span class="s1">&#39;default&#39;</span><span class="p">]</span>

    <span class="k">def</span> <span class="nf">_inject_commands</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">executables</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;For add_expand_vars, inject all commands&quot;&quot;&quot;</span>
        <span class="n">command</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="c1"># Inject all prepended chained experiments</span>
        <span class="k">for</span> <span class="n">chained_exp</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">chain_prepend</span><span class="p">:</span>
            <span class="n">command</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">chain_commands</span><span class="p">[</span><span class="n">chained_exp</span><span class="p">])</span>

        <span class="c1"># ensure all log files are purged and set up</span>
        <span class="n">logs</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
        <span class="n">builtin_regex</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;</span><span class="si">%s</span><span class="s1">(?P&lt;func&gt;.*)&#39;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">_exec_prefix_builtin</span><span class="p">)</span>
        <span class="n">modifier_regex</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="n">ramble</span><span class="o">.</span><span class="n">modifier</span><span class="o">.</span><span class="n">ModifierBase</span><span class="o">.</span><span class="n">_mod_prefix_builtin</span> <span class="o">+</span>
                                    <span class="sa">r</span><span class="s1">&#39;(?P&lt;func&gt;.*)&#39;</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">executable</span> <span class="ow">in</span> <span class="n">executables</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">builtin_regex</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="n">executable</span><span class="p">)</span> <span class="ow">and</span> \
                    <span class="ow">not</span> <span class="n">modifier_regex</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="n">executable</span><span class="p">):</span>
                <span class="n">command_config</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">executables</span><span class="p">[</span><span class="n">executable</span><span class="p">]</span>
                <span class="k">if</span> <span class="n">command_config</span><span class="o">.</span><span class="n">redirect</span><span class="p">:</span>
                    <span class="n">logs</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">command_config</span><span class="o">.</span><span class="n">redirect</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">log</span> <span class="ow">in</span> <span class="n">logs</span><span class="p">:</span>
            <span class="n">command</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;rm -f &quot;</span><span class="si">%s</span><span class="s1">&quot;&#39;</span> <span class="o">%</span> <span class="n">log</span><span class="p">)</span>
            <span class="n">command</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;touch &quot;</span><span class="si">%s</span><span class="s1">&quot;&#39;</span> <span class="o">%</span> <span class="n">log</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">executable</span> <span class="ow">in</span> <span class="n">executables</span><span class="p">:</span>
            <span class="n">builtin_match</span> <span class="o">=</span> <span class="n">builtin_regex</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="n">executable</span><span class="p">)</span>

            <span class="n">exec_vars</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;executable_name&#39;</span><span class="p">:</span> <span class="n">executable</span><span class="p">}</span>

            <span class="k">for</span> <span class="n">mod</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_modifier_instances</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">mod</span><span class="o">.</span><span class="n">applies_to_executable</span><span class="p">(</span><span class="n">executable</span><span class="p">):</span>
                    <span class="n">exec_vars</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">mod</span><span class="o">.</span><span class="n">modded_variables</span><span class="p">(</span><span class="bp">self</span><span class="p">))</span>

            <span class="k">if</span> <span class="n">builtin_match</span><span class="p">:</span>
                <span class="c1"># Process builtin executables</span>

                <span class="c1"># Get internal method:</span>
                <span class="n">func_name</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">builtin_match</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="s2">&quot;func&quot;</span><span class="p">)</span><span class="si">}</span><span class="s1">&#39;</span>
                <span class="n">func</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">func_name</span><span class="p">)</span>
                <span class="n">func_cmds</span> <span class="o">=</span> <span class="n">func</span><span class="p">()</span>
                <span class="k">for</span> <span class="n">cmd</span> <span class="ow">in</span> <span class="n">func_cmds</span><span class="p">:</span>
                    <span class="n">command</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">expander</span><span class="o">.</span><span class="n">expand_var</span><span class="p">(</span><span class="n">cmd</span><span class="p">,</span> <span class="n">exec_vars</span><span class="p">))</span>
            <span class="k">elif</span> <span class="n">executable</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_modifier_builtins</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
                <span class="n">builtin_def</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_modifier_builtins</span><span class="p">[</span><span class="n">executable</span><span class="p">]</span>
                <span class="n">func</span> <span class="o">=</span> <span class="n">builtin_def</span><span class="p">[</span><span class="s1">&#39;func&#39;</span><span class="p">]</span>
                <span class="n">func_cmds</span> <span class="o">=</span> <span class="n">func</span><span class="p">()</span>
                <span class="k">for</span> <span class="n">cmd</span> <span class="ow">in</span> <span class="n">func_cmds</span><span class="p">:</span>
                    <span class="n">command</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">expander</span><span class="o">.</span><span class="n">expand_var</span><span class="p">(</span><span class="n">cmd</span><span class="p">,</span> <span class="n">exec_vars</span><span class="p">))</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="c1"># Process directive defined executables</span>
                <span class="n">base_command</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">executables</span><span class="p">[</span><span class="n">executable</span><span class="p">]</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
                <span class="n">pre_commands</span> <span class="o">=</span> <span class="p">[]</span>
                <span class="n">post_commands</span> <span class="o">=</span> <span class="p">[]</span>

                <span class="k">for</span> <span class="n">mod</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_modifier_instances</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">mod</span><span class="o">.</span><span class="n">applies_to_executable</span><span class="p">(</span><span class="n">executable</span><span class="p">):</span>
                        <span class="n">pre_cmd</span><span class="p">,</span> <span class="n">post_cmd</span> <span class="o">=</span> <span class="n">mod</span><span class="o">.</span><span class="n">apply_executable_modifiers</span><span class="p">(</span><span class="n">executable</span><span class="p">,</span>
                                                                           <span class="n">base_command</span><span class="p">,</span>
                                                                           <span class="n">app_inst</span><span class="o">=</span><span class="bp">self</span><span class="p">)</span>
                        <span class="n">pre_commands</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">pre_cmd</span><span class="p">)</span>
                        <span class="n">post_commands</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">post_cmd</span><span class="p">)</span>

                <span class="n">command_configs</span> <span class="o">=</span> <span class="n">pre_commands</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
                <span class="n">command_configs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">base_command</span><span class="p">)</span>
                <span class="n">command_configs</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">post_commands</span><span class="p">)</span>

                <span class="k">for</span> <span class="n">cmd_conf</span> <span class="ow">in</span> <span class="n">command_configs</span><span class="p">:</span>
                    <span class="n">mpi_cmd</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
                    <span class="k">if</span> <span class="n">cmd_conf</span><span class="o">.</span><span class="n">mpi</span><span class="p">:</span>
                        <span class="n">mpi_cmd</span> <span class="o">=</span> <span class="s1">&#39; &#39;</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">expander</span><span class="o">.</span><span class="n">expand_var</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">{mpi_command}</span><span class="s1">&#39;</span><span class="p">,</span> <span class="n">exec_vars</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39; &#39;</span>

                    <span class="n">redirect</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
                    <span class="k">if</span> <span class="n">cmd_conf</span><span class="o">.</span><span class="n">redirect</span><span class="p">:</span>
                        <span class="n">out_log</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">expander</span><span class="o">.</span><span class="n">expand_var</span><span class="p">(</span><span class="n">cmd_conf</span><span class="o">.</span><span class="n">redirect</span><span class="p">,</span> <span class="n">exec_vars</span><span class="p">)</span>
                        <span class="n">output_operator</span> <span class="o">=</span> <span class="n">cmd_conf</span><span class="o">.</span><span class="n">output_capture</span>
                        <span class="n">redirect</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39; </span><span class="si">{</span><span class="n">output_operator</span><span class="si">}</span><span class="s1"> &quot;</span><span class="si">{</span><span class="n">out_log</span><span class="si">}</span><span class="s1">&quot;&#39;</span>

                    <span class="k">for</span> <span class="n">part</span> <span class="ow">in</span> <span class="n">cmd_conf</span><span class="o">.</span><span class="n">template</span><span class="p">:</span>
                        <span class="n">command_part</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">mpi_cmd</span><span class="si">}{</span><span class="n">part</span><span class="si">}{</span><span class="n">redirect</span><span class="si">}</span><span class="s1">&#39;</span>
                        <span class="n">command</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">expander</span><span class="o">.</span><span class="n">expand_var</span><span class="p">(</span><span class="n">command_part</span><span class="p">,</span> <span class="n">exec_vars</span><span class="p">))</span>

        <span class="c1"># Inject all appended chained experiments</span>
        <span class="k">for</span> <span class="n">chained_exp</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">chain_append</span><span class="p">:</span>
            <span class="n">command</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">chain_commands</span><span class="p">[</span><span class="n">chained_exp</span><span class="p">])</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">variables</span><span class="p">[</span><span class="s1">&#39;command&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">command</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_derive_variables_for_template_path</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">workspace</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Define variables for template paths (for add_expand_vars)&quot;&quot;&quot;</span>
        <span class="k">for</span> <span class="n">template_name</span><span class="p">,</span> <span class="n">_</span> <span class="ow">in</span> <span class="n">workspace</span><span class="o">.</span><span class="n">all_templates</span><span class="p">():</span>
            <span class="n">expand_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">expander</span><span class="o">.</span><span class="n">expand_var</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="se">{{</span><span class="s1">experiment_run_dir</span><span class="se">}}</span><span class="s1">&#39;</span><span class="p">),</span>  <span class="c1"># noqa: F541</span>
                <span class="n">template_name</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">variables</span><span class="p">[</span><span class="n">template_name</span><span class="p">]</span> <span class="o">=</span> <span class="n">expand_path</span>

    <span class="k">def</span> <span class="nf">_validate_experiment</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Perform validation of an experiment before performing actions with it</span>

<span class="sd">        This function is an entry point to validate various aspects of an</span>
<span class="sd">        experiment definition before it is used. It is expected to raise errors</span>
<span class="sd">        when validation fails.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">expander</span><span class="o">.</span><span class="n">workload_name</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">workloads</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">ApplicationError</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Workload </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">expander</span><span class="o">.</span><span class="n">workload_name</span><span class="si">}</span><span class="s1"> is not defined &#39;</span>
                                   <span class="sa">f</span><span class="s1">&#39;as a workload of application </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s1">.&#39;</span><span class="p">)</span>

<div class="viewcode-block" id="ApplicationBase.add_expand_vars">
<a class="viewcode-back" href="../../ramble.html#ramble.application.ApplicationBase.add_expand_vars">[docs]</a>
    <span class="k">def</span> <span class="nf">add_expand_vars</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">workspace</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Add application specific expansion variables</span>

<span class="sd">        Applications require several variables to be defined to function properly.</span>
<span class="sd">        This method defines these variables, including:</span>
<span class="sd">        - command: set to the commands needed to execute the experiment</span>
<span class="sd">        - spack_setup: set to an empty string, so spack applications can override this</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_vars_are_expanded</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_validate_experiment</span><span class="p">()</span>
            <span class="n">executables</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_executables</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_set_default_experiment_variables</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_set_input_path</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_inject_commands</span><span class="p">(</span><span class="n">executables</span><span class="p">)</span>
            <span class="c1"># ---------------------------------------------------------------------------------</span>
            <span class="c1"># TODO (dwj): Remove this after we validate that &#39;spack_setup&#39; is not in templates.</span>
            <span class="c1">#             this is no longer needed, as spack was converted to builtins.</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">variables</span><span class="p">[</span><span class="s1">&#39;spack_setup&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
            <span class="c1"># ---------------------------------------------------------------------------------</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_derive_variables_for_template_path</span><span class="p">(</span><span class="n">workspace</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_vars_are_expanded</span> <span class="o">=</span> <span class="kc">True</span></div>


    <span class="k">def</span> <span class="nf">_inputs_and_fetchers</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">workload</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Extract all inputs for a given workload</span>

<span class="sd">        Take a workload name and extract all inputs for the workload.</span>
<span class="sd">        If the workload is set to None, extract all inputs for all workloads.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_input_fetchers</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">return</span>

        <span class="n">workload_names</span> <span class="o">=</span> <span class="p">[</span><span class="n">workload</span><span class="p">]</span> <span class="k">if</span> <span class="n">workload</span> <span class="k">else</span> <span class="bp">self</span><span class="o">.</span><span class="n">workloads</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span>

        <span class="n">inputs</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">for</span> <span class="n">workload_name</span> <span class="ow">in</span> <span class="n">workload_names</span><span class="p">:</span>
            <span class="n">workload</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">workloads</span><span class="p">[</span><span class="n">workload_name</span><span class="p">]</span>

            <span class="k">for</span> <span class="n">input_file</span> <span class="ow">in</span> <span class="n">workload</span><span class="p">[</span><span class="s1">&#39;inputs&#39;</span><span class="p">]:</span>
                <span class="n">input_conf</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">inputs</span><span class="p">[</span><span class="n">input_file</span><span class="p">]</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>

                <span class="c1"># Expand input value as it may be a var</span>
                <span class="n">expanded_url</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">expander</span><span class="o">.</span><span class="n">expand_var</span><span class="p">(</span><span class="n">input_conf</span><span class="p">[</span><span class="s1">&#39;url&#39;</span><span class="p">])</span>
                <span class="n">input_conf</span><span class="p">[</span><span class="s1">&#39;url&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">expanded_url</span>

                <span class="n">fetcher</span> <span class="o">=</span> <span class="n">ramble</span><span class="o">.</span><span class="n">fetch_strategy</span><span class="o">.</span><span class="n">URLFetchStrategy</span><span class="p">(</span><span class="o">**</span><span class="n">input_conf</span><span class="p">)</span>

                <span class="n">file_name</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="n">input_conf</span><span class="p">[</span><span class="s1">&#39;url&#39;</span><span class="p">])</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">fetcher</span><span class="o">.</span><span class="n">extension</span><span class="p">:</span>
                    <span class="n">fetcher</span><span class="o">.</span><span class="n">extension</span> <span class="o">=</span> <span class="n">spack</span><span class="o">.</span><span class="n">util</span><span class="o">.</span><span class="n">compression</span><span class="o">.</span><span class="n">extension</span><span class="p">(</span><span class="n">file_name</span><span class="p">)</span>

                <span class="n">file_name</span> <span class="o">=</span> <span class="n">file_name</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;.</span><span class="si">{</span><span class="n">fetcher</span><span class="o">.</span><span class="n">extension</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)</span>

                <span class="n">namespace</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s1">.</span><span class="si">{</span><span class="n">workload_name</span><span class="si">}</span><span class="s1">&#39;</span>

                <span class="n">inputs</span><span class="p">[</span><span class="n">file_name</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;fetcher&#39;</span><span class="p">:</span> <span class="n">fetcher</span><span class="p">,</span>
                                     <span class="s1">&#39;namespace&#39;</span><span class="p">:</span> <span class="n">namespace</span><span class="p">,</span>
                                     <span class="s1">&#39;target_dir&#39;</span><span class="p">:</span> <span class="n">input_conf</span><span class="p">[</span><span class="s1">&#39;target_dir&#39;</span><span class="p">],</span>
                                     <span class="s1">&#39;extension&#39;</span><span class="p">:</span> <span class="n">fetcher</span><span class="o">.</span><span class="n">extension</span><span class="p">,</span>
                                     <span class="s1">&#39;input_name&#39;</span><span class="p">:</span> <span class="n">input_file</span><span class="p">,</span>
                                     <span class="s1">&#39;expand&#39;</span><span class="p">:</span> <span class="n">input_conf</span><span class="p">[</span><span class="s1">&#39;expand&#39;</span><span class="p">]</span>
                                     <span class="p">}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_input_fetchers</span> <span class="o">=</span> <span class="n">inputs</span>

    <span class="n">register_phase</span><span class="p">(</span><span class="s1">&#39;mirror_inputs&#39;</span><span class="p">,</span> <span class="n">pipeline</span><span class="o">=</span><span class="s1">&#39;mirror&#39;</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_mirror_inputs</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">workspace</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Mirror application inputs</span>

<span class="sd">        Perform mirroring of inputs within this application class.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_inputs_and_fetchers</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">expander</span><span class="o">.</span><span class="n">workload_name</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">input_file</span><span class="p">,</span> <span class="n">input_conf</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_input_fetchers</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="n">mirror_paths</span> <span class="o">=</span> <span class="n">ramble</span><span class="o">.</span><span class="n">mirror</span><span class="o">.</span><span class="n">mirror_archive_paths</span><span class="p">(</span>
                <span class="n">input_conf</span><span class="p">[</span><span class="s1">&#39;fetcher&#39;</span><span class="p">],</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">input_file</span><span class="p">))</span>
            <span class="n">fetch_dir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">workspace</span><span class="o">.</span><span class="n">input_mirror_path</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
            <span class="n">fs</span><span class="o">.</span><span class="n">mkdirp</span><span class="p">(</span><span class="n">fetch_dir</span><span class="p">)</span>
            <span class="n">stage</span> <span class="o">=</span> <span class="n">ramble</span><span class="o">.</span><span class="n">stage</span><span class="o">.</span><span class="n">InputStage</span><span class="p">(</span><span class="n">input_conf</span><span class="p">[</span><span class="s1">&#39;fetcher&#39;</span><span class="p">],</span> <span class="n">name</span><span class="o">=</span><span class="n">input_conf</span><span class="p">[</span><span class="s1">&#39;namespace&#39;</span><span class="p">],</span>
                                            <span class="n">path</span><span class="o">=</span><span class="n">fetch_dir</span><span class="p">,</span> <span class="n">mirror_paths</span><span class="o">=</span><span class="n">mirror_paths</span><span class="p">,</span> <span class="n">lock</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

            <span class="n">stage</span><span class="o">.</span><span class="n">cache_mirror</span><span class="p">(</span><span class="n">workspace</span><span class="o">.</span><span class="n">input_mirror_cache</span><span class="p">,</span> <span class="n">workspace</span><span class="o">.</span><span class="n">input_mirror_stats</span><span class="p">)</span>

    <span class="n">register_phase</span><span class="p">(</span><span class="s1">&#39;get_inputs&#39;</span><span class="p">,</span> <span class="n">pipeline</span><span class="o">=</span><span class="s1">&#39;setup&#39;</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_get_inputs</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">workspace</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Download application inputs</span>

<span class="sd">        Download application inputs into the proper directory within the workspace.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">workload_namespace</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">expander</span><span class="o">.</span><span class="n">workload_namespace</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_inputs_and_fetchers</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">expander</span><span class="o">.</span><span class="n">workload_name</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">input_file</span><span class="p">,</span> <span class="n">input_conf</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_input_fetchers</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">workspace</span><span class="o">.</span><span class="n">dry_run</span><span class="p">:</span>
                <span class="n">input_vars</span> <span class="o">=</span> <span class="p">{</span><span class="bp">self</span><span class="o">.</span><span class="n">keywords</span><span class="o">.</span><span class="n">input_name</span><span class="p">:</span> <span class="n">input_conf</span><span class="p">[</span><span class="s1">&#39;input_name&#39;</span><span class="p">]}</span>
                <span class="n">input_namespace</span> <span class="o">=</span> <span class="n">workload_namespace</span> <span class="o">+</span> <span class="s1">&#39;.&#39;</span> <span class="o">+</span> <span class="n">input_file</span>
                <span class="n">input_path</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">expander</span><span class="o">.</span><span class="n">expand_var</span><span class="p">(</span><span class="n">input_conf</span><span class="p">[</span><span class="s1">&#39;target_dir&#39;</span><span class="p">],</span>
                                                      <span class="n">extra_vars</span><span class="o">=</span><span class="n">input_vars</span><span class="p">)</span>
                <span class="n">input_tuple</span> <span class="o">=</span> <span class="p">(</span><span class="s1">&#39;input-file&#39;</span><span class="p">,</span> <span class="n">input_path</span><span class="p">)</span>

                <span class="c1"># Skip inputs that have already been cached</span>
                <span class="k">if</span> <span class="n">workspace</span><span class="o">.</span><span class="n">check_cache</span><span class="p">(</span><span class="n">input_tuple</span><span class="p">):</span>
                    <span class="k">continue</span>

                <span class="n">mirror_paths</span> <span class="o">=</span> <span class="n">ramble</span><span class="o">.</span><span class="n">mirror</span><span class="o">.</span><span class="n">mirror_archive_paths</span><span class="p">(</span>
                    <span class="n">input_conf</span><span class="p">[</span><span class="s1">&#39;fetcher&#39;</span><span class="p">],</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">input_file</span><span class="p">))</span>

                <span class="k">with</span> <span class="n">ramble</span><span class="o">.</span><span class="n">stage</span><span class="o">.</span><span class="n">InputStage</span><span class="p">(</span><span class="n">input_conf</span><span class="p">[</span><span class="s1">&#39;fetcher&#39;</span><span class="p">],</span> <span class="n">name</span><span class="o">=</span><span class="n">input_namespace</span><span class="p">,</span>
                                             <span class="n">path</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">expander</span><span class="o">.</span><span class="n">workload_input_dir</span><span class="p">,</span>
                                             <span class="n">mirror_paths</span><span class="o">=</span><span class="n">mirror_paths</span><span class="p">)</span> \
                        <span class="k">as</span> <span class="n">stage</span><span class="p">:</span>
                    <span class="n">stage</span><span class="o">.</span><span class="n">set_subdir</span><span class="p">(</span><span class="n">input_path</span><span class="p">)</span>
                    <span class="n">stage</span><span class="o">.</span><span class="n">fetch</span><span class="p">()</span>
                    <span class="k">if</span> <span class="n">input_conf</span><span class="p">[</span><span class="s1">&#39;fetcher&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">digest</span><span class="p">:</span>
                        <span class="n">stage</span><span class="o">.</span><span class="n">check</span><span class="p">()</span>
                    <span class="n">stage</span><span class="o">.</span><span class="n">cache_local</span><span class="p">()</span>

                    <span class="k">if</span> <span class="n">input_conf</span><span class="p">[</span><span class="s1">&#39;expand&#39;</span><span class="p">]:</span>
                        <span class="k">try</span><span class="p">:</span>
                            <span class="n">stage</span><span class="o">.</span><span class="n">expand_archive</span><span class="p">()</span>
                        <span class="k">except</span> <span class="n">spack</span><span class="o">.</span><span class="n">util</span><span class="o">.</span><span class="n">executable</span><span class="o">.</span><span class="n">ProcessError</span><span class="p">:</span>
                            <span class="k">pass</span>

                <span class="n">workspace</span><span class="o">.</span><span class="n">add_to_cache</span><span class="p">(</span><span class="n">input_tuple</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">msg</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;DRY-RUN: Would download </span><span class="si">{</span><span class="n">input_conf</span><span class="p">[</span><span class="s2">&quot;fetcher&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">url</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_prepare_license_path</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">workspace</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">license_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">workspace</span><span class="o">.</span><span class="n">shared_license_dir</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">license_file</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">license_path</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">license_inc_name</span><span class="p">)</span>

        <span class="n">fs</span><span class="o">.</span><span class="n">mkdirp</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">license_path</span><span class="p">)</span>

    <span class="n">register_phase</span><span class="p">(</span><span class="s1">&#39;license_includes&#39;</span><span class="p">,</span> <span class="n">pipeline</span><span class="o">=</span><span class="s1">&#39;setup&#39;</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_license_includes</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">workspace</span><span class="p">):</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Writing License Includes&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_prepare_license_path</span><span class="p">(</span><span class="n">workspace</span><span class="p">)</span>

        <span class="n">action_funcs</span> <span class="o">=</span> <span class="n">ramble</span><span class="o">.</span><span class="n">util</span><span class="o">.</span><span class="n">env</span><span class="o">.</span><span class="n">action_funcs</span>
        <span class="n">config_scopes</span> <span class="o">=</span> <span class="n">ramble</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">scopes</span><span class="p">()</span>
        <span class="n">shell</span> <span class="o">=</span> <span class="n">ramble</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;config:shell&#39;</span><span class="p">)</span>
        <span class="n">var_set</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">scope</span> <span class="ow">in</span> <span class="n">config_scopes</span><span class="p">:</span>
            <span class="n">license_conf</span> <span class="o">=</span> <span class="n">ramble</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">get_config</span><span class="p">(</span><span class="s1">&#39;licenses&#39;</span><span class="p">,</span>
                                                           <span class="n">scope</span><span class="o">=</span><span class="n">scope</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">license_conf</span><span class="p">:</span>
                <span class="n">app_licenses</span> <span class="o">=</span> <span class="n">license_conf</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">]</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span> \
                    <span class="ow">in</span> <span class="n">license_conf</span> <span class="k">else</span> <span class="p">{}</span>

                <span class="k">for</span> <span class="n">action</span><span class="p">,</span> <span class="n">conf</span> <span class="ow">in</span> <span class="n">app_licenses</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                    <span class="p">(</span><span class="n">env_cmds</span><span class="p">,</span> <span class="n">var_set</span><span class="p">)</span> <span class="o">=</span> <span class="n">action_funcs</span><span class="p">[</span><span class="n">action</span><span class="p">](</span><span class="n">conf</span><span class="p">,</span>
                                                               <span class="n">var_set</span><span class="p">,</span>
                                                               <span class="n">shell</span><span class="o">=</span><span class="n">shell</span><span class="p">)</span>

                    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">license_file</span><span class="p">,</span> <span class="s1">&#39;w+&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
                        <span class="k">for</span> <span class="n">cmd</span> <span class="ow">in</span> <span class="n">env_cmds</span><span class="p">:</span>
                            <span class="k">if</span> <span class="n">cmd</span><span class="p">:</span>
                                <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">cmd</span> <span class="o">+</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>

    <span class="n">register_phase</span><span class="p">(</span><span class="s1">&#39;make_experiments&#39;</span><span class="p">,</span> <span class="n">pipeline</span><span class="o">=</span><span class="s1">&#39;setup&#39;</span><span class="p">,</span> <span class="n">depends_on</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;get_inputs&#39;</span><span class="p">])</span>

    <span class="k">def</span> <span class="nf">_make_experiments</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">workspace</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Create experiment directories</span>

<span class="sd">        Create the experiment this application encapsulates. This includes</span>
<span class="sd">        creating the experiment run directory, rendering the necessary</span>
<span class="sd">        templates, and injecting the experiment into the workspace all</span>
<span class="sd">        experiments file.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">experiment_run_dir</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">expander</span><span class="o">.</span><span class="n">experiment_run_dir</span>
        <span class="n">fs</span><span class="o">.</span><span class="n">mkdirp</span><span class="p">(</span><span class="n">experiment_run_dir</span><span class="p">)</span>

        <span class="n">exec_vars</span> <span class="o">=</span> <span class="p">{}</span>

        <span class="k">for</span> <span class="n">mod</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_modifier_instances</span><span class="p">:</span>
            <span class="n">exec_vars</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">mod</span><span class="o">.</span><span class="n">modded_variables</span><span class="p">(</span><span class="bp">self</span><span class="p">))</span>

        <span class="k">for</span> <span class="n">template_name</span><span class="p">,</span> <span class="n">template_conf</span> <span class="ow">in</span> <span class="n">workspace</span><span class="o">.</span><span class="n">all_templates</span><span class="p">():</span>
            <span class="n">expand_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">experiment_run_dir</span><span class="p">,</span> <span class="n">template_name</span><span class="p">)</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">msg</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Writing template </span><span class="si">{</span><span class="n">template_name</span><span class="si">}</span><span class="s1"> to </span><span class="si">{</span><span class="n">expand_path</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>

            <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">expand_path</span><span class="p">,</span> <span class="s1">&#39;w+&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
                <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">expander</span><span class="o">.</span><span class="n">expand_var</span><span class="p">(</span><span class="n">template_conf</span><span class="p">[</span><span class="s1">&#39;contents&#39;</span><span class="p">],</span>
                                                 <span class="n">extra_vars</span><span class="o">=</span><span class="n">exec_vars</span><span class="p">))</span>
            <span class="n">os</span><span class="o">.</span><span class="n">chmod</span><span class="p">(</span><span class="n">expand_path</span><span class="p">,</span> <span class="n">stat</span><span class="o">.</span><span class="n">S_IRWXU</span> <span class="o">|</span> <span class="n">stat</span><span class="o">.</span><span class="n">S_IRWXG</span>
                     <span class="o">|</span> <span class="n">stat</span><span class="o">.</span><span class="n">S_IROTH</span> <span class="o">|</span> <span class="n">stat</span><span class="o">.</span><span class="n">S_IXOTH</span><span class="p">)</span>

        <span class="n">experiment_script</span> <span class="o">=</span> <span class="n">workspace</span><span class="o">.</span><span class="n">experiments_script</span>
        <span class="n">experiment_script</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">expander</span><span class="o">.</span><span class="n">expand_var</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">{batch_submit}</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">set_status</span><span class="p">(</span><span class="n">status</span><span class="o">=</span><span class="s1">&#39;UNKNOWN&#39;</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_clean_hash_variables</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">workspace</span><span class="p">,</span> <span class="n">variables</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Cleanup variables to hash before computing the hash</span>

<span class="sd">        Perform some general cleanup operations on variables</span>
<span class="sd">        before hashing, to help give useful hashes.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="c1"># Purge workspace name, as this shouldn&#39;t affect the experiments</span>
        <span class="k">if</span> <span class="s1">&#39;workspace_name&#39;</span> <span class="ow">in</span> <span class="n">variables</span><span class="p">:</span>
            <span class="k">del</span> <span class="n">variables</span><span class="p">[</span><span class="s1">&#39;workspace_name&#39;</span><span class="p">]</span>

        <span class="c1"># Remove the workspace path from variable definitions before hashing</span>
        <span class="k">for</span> <span class="n">var</span> <span class="ow">in</span> <span class="n">variables</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">variables</span><span class="p">[</span><span class="n">var</span><span class="p">],</span> <span class="n">six</span><span class="o">.</span><span class="n">string_types</span><span class="p">):</span>
                <span class="n">variables</span><span class="p">[</span><span class="n">var</span><span class="p">]</span> <span class="o">=</span> <span class="n">variables</span><span class="p">[</span><span class="n">var</span><span class="p">]</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="n">workspace</span><span class="o">.</span><span class="n">root</span> <span class="o">+</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">sep</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)</span>

<div class="viewcode-block" id="ApplicationBase.populate_inventory">
<a class="viewcode-back" href="../../ramble.html#ramble.application.ApplicationBase.populate_inventory">[docs]</a>
    <span class="k">def</span> <span class="nf">populate_inventory</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">workspace</span><span class="p">,</span> <span class="n">force_compute</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">require_exist</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Populate this experiment&#39;s hash inventory</span>

<span class="sd">        If an inventory file exists, read it first.</span>
<span class="sd">        If it does not exist, compute it using the internal information.</span>

<span class="sd">        If force_compute is set to true, always compute and never read.</span>

<span class="sd">        Args:</span>
<span class="sd">            force_compute: Boolean that allows forces the inventory to be computed instead of read</span>
<span class="sd">                           Used in pipelines that should create the inventory, instead of</span>
<span class="sd">                           consuming it.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">experiment_run_dir</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">expander</span><span class="o">.</span><span class="n">experiment_run_dir</span>
        <span class="n">inventory_file</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">experiment_run_dir</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_inventory_file_name</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">inventory_file</span><span class="p">)</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">force_compute</span><span class="p">:</span>
            <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">inventory_file</span><span class="p">,</span> <span class="s1">&#39;r&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">hash_inventory</span> <span class="o">=</span> <span class="n">spack</span><span class="o">.</span><span class="n">util</span><span class="o">.</span><span class="n">spack_json</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>

        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># Clean up variables before hashing</span>
            <span class="n">vars_to_hash</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">variables</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_clean_hash_variables</span><span class="p">(</span><span class="n">workspace</span><span class="p">,</span> <span class="n">vars_to_hash</span><span class="p">)</span>

            <span class="c1"># Build inventory of attributes</span>
            <span class="n">attributes_to_hash</span> <span class="o">=</span> <span class="p">[</span>
                <span class="p">(</span><span class="s1">&#39;variables&#39;</span><span class="p">,</span> <span class="n">vars_to_hash</span><span class="p">),</span>
                <span class="p">(</span><span class="s1">&#39;modifiers&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">modifiers</span><span class="p">),</span>
                <span class="p">(</span><span class="s1">&#39;chained_experiments&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">chained_experiments</span><span class="p">),</span>
                <span class="p">(</span><span class="s1">&#39;internals&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">internals</span><span class="p">),</span>
                <span class="p">(</span><span class="s1">&#39;env_vars&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_env_variable_sets</span><span class="p">),</span>
            <span class="p">]</span>

            <span class="k">for</span> <span class="n">attr</span><span class="p">,</span> <span class="n">attr_dict</span> <span class="ow">in</span> <span class="n">attributes_to_hash</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">hash_inventory</span><span class="p">[</span><span class="s1">&#39;attributes&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                    <span class="p">{</span>
                        <span class="s1">&#39;name&#39;</span><span class="p">:</span> <span class="n">attr</span><span class="p">,</span>
                        <span class="s1">&#39;digest&#39;</span><span class="p">:</span> <span class="n">ramble</span><span class="o">.</span><span class="n">util</span><span class="o">.</span><span class="n">hashing</span><span class="o">.</span><span class="n">hash_json</span><span class="p">(</span><span class="n">attr_dict</span><span class="p">),</span>
                    <span class="p">}</span>
                <span class="p">)</span>

            <span class="c1"># Build inventory of workspace templates</span>
            <span class="k">for</span> <span class="n">template_name</span><span class="p">,</span> <span class="n">template_conf</span> <span class="ow">in</span> <span class="n">workspace</span><span class="o">.</span><span class="n">all_templates</span><span class="p">():</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">hash_inventory</span><span class="p">[</span><span class="s1">&#39;templates&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                    <span class="p">{</span>
                        <span class="s1">&#39;name&#39;</span><span class="p">:</span> <span class="n">template_name</span><span class="p">,</span>
                        <span class="s1">&#39;digest&#39;</span><span class="p">:</span> <span class="n">template_conf</span><span class="p">[</span><span class="s1">&#39;digest&#39;</span><span class="p">],</span>
                    <span class="p">}</span>
                <span class="p">)</span>

            <span class="c1"># Build inventory of inputs</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_inputs_and_fetchers</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">expander</span><span class="o">.</span><span class="n">workload_name</span><span class="p">)</span>

            <span class="k">for</span> <span class="n">input_file</span><span class="p">,</span> <span class="n">input_conf</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_input_fetchers</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                <span class="k">if</span> <span class="n">input_conf</span><span class="p">[</span><span class="s1">&#39;fetcher&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">digest</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">hash_inventory</span><span class="p">[</span><span class="s1">&#39;inputs&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                        <span class="p">{</span>
                            <span class="s1">&#39;name&#39;</span><span class="p">:</span> <span class="n">input_conf</span><span class="p">[</span><span class="s1">&#39;input_name&#39;</span><span class="p">],</span>
                            <span class="s1">&#39;digest&#39;</span><span class="p">:</span> <span class="n">input_conf</span><span class="p">[</span><span class="s1">&#39;fetcher&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">digest</span>
                        <span class="p">}</span>
                    <span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">hash_inventory</span><span class="p">[</span><span class="s1">&#39;inputs&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                        <span class="p">{</span>
                            <span class="s1">&#39;name&#39;</span><span class="p">:</span> <span class="n">input_conf</span><span class="p">[</span><span class="s1">&#39;input_name&#39;</span><span class="p">],</span>
                            <span class="s1">&#39;digest&#39;</span><span class="p">:</span> <span class="n">ramble</span><span class="o">.</span><span class="n">util</span><span class="o">.</span><span class="n">hashing</span><span class="o">.</span><span class="n">hash_string</span><span class="p">(</span><span class="n">input_conf</span><span class="p">[</span><span class="s1">&#39;fetcher&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">url</span><span class="p">),</span>
                        <span class="p">}</span>
                    <span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">experiment_hash</span> <span class="o">=</span> <span class="n">ramble</span><span class="o">.</span><span class="n">util</span><span class="o">.</span><span class="n">hashing</span><span class="o">.</span><span class="n">hash_json</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">hash_inventory</span><span class="p">)</span></div>


    <span class="n">register_phase</span><span class="p">(</span><span class="s1">&#39;write_inventory&#39;</span><span class="p">,</span> <span class="n">pipeline</span><span class="o">=</span><span class="s1">&#39;setup&#39;</span><span class="p">,</span> <span class="n">depends_on</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;make_experiments&#39;</span><span class="p">])</span>

    <span class="k">def</span> <span class="nf">_write_inventory</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">workspace</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Build and write an inventory of an experiment</span>

<span class="sd">        Write an inventory file describing all of the contents of this</span>
<span class="sd">        experiment.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">experiment_run_dir</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">expander</span><span class="o">.</span><span class="n">experiment_run_dir</span>
        <span class="n">inventory_file</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">experiment_run_dir</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_inventory_file_name</span><span class="p">)</span>

        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">inventory_file</span><span class="p">,</span> <span class="s1">&#39;w+&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
            <span class="n">spack</span><span class="o">.</span><span class="n">util</span><span class="o">.</span><span class="n">spack_json</span><span class="o">.</span><span class="n">dump</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">hash_inventory</span><span class="p">,</span> <span class="n">f</span><span class="p">)</span>

    <span class="n">register_phase</span><span class="p">(</span><span class="s1">&#39;archive_experiments&#39;</span><span class="p">,</span> <span class="n">pipeline</span><span class="o">=</span><span class="s1">&#39;archive&#39;</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_archive_experiments</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">workspace</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Archive an experiment directory</span>

<span class="sd">        Perform the archiving action on an experiment.</span>
<span class="sd">        This includes capturing:</span>
<span class="sd">        - Rendered templates within the experiment directory</span>
<span class="sd">        - All files that contain a figure of merit or success criteria</span>
<span class="sd">        - Any files that match an archive pattern</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="kn">import</span> <span class="nn">glob</span>
        <span class="n">experiment_run_dir</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">expander</span><span class="o">.</span><span class="n">experiment_run_dir</span>
        <span class="n">ws_archive_dir</span> <span class="o">=</span> <span class="n">workspace</span><span class="o">.</span><span class="n">latest_archive_path</span>

        <span class="n">archive_experiment_dir</span> <span class="o">=</span> <span class="n">experiment_run_dir</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="n">workspace</span><span class="o">.</span><span class="n">root</span><span class="p">,</span>
                                                            <span class="n">ws_archive_dir</span><span class="p">)</span>

        <span class="n">fs</span><span class="o">.</span><span class="n">mkdirp</span><span class="p">(</span><span class="n">archive_experiment_dir</span><span class="p">)</span>

        <span class="c1"># Copy all of the templates to the archive directory</span>
        <span class="k">for</span> <span class="n">template_name</span><span class="p">,</span> <span class="n">_</span> <span class="ow">in</span> <span class="n">workspace</span><span class="o">.</span><span class="n">all_templates</span><span class="p">():</span>
            <span class="n">src</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">experiment_run_dir</span><span class="p">,</span> <span class="n">template_name</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">src</span><span class="p">):</span>
                <span class="n">shutil</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="n">src</span><span class="p">,</span> <span class="n">archive_experiment_dir</span><span class="p">)</span>

        <span class="c1"># Copy all figure of merit files</span>
        <span class="n">criteria_list</span> <span class="o">=</span> <span class="n">workspace</span><span class="o">.</span><span class="n">success_list</span>
        <span class="n">analysis_files</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_analysis_dicts</span><span class="p">(</span><span class="n">criteria_list</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">file</span><span class="p">,</span> <span class="n">file_conf</span> <span class="ow">in</span> <span class="n">analysis_files</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">file</span><span class="p">):</span>
                <span class="n">shutil</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="n">file</span><span class="p">,</span> <span class="n">archive_experiment_dir</span><span class="p">)</span>

        <span class="c1"># Copy all archive patterns</span>
        <span class="n">archive_patterns</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">archive_patterns</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>
        <span class="k">for</span> <span class="n">mod</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_modifier_instances</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">pattern</span> <span class="ow">in</span> <span class="n">mod</span><span class="o">.</span><span class="n">archive_patterns</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
                <span class="n">archive_patterns</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">pattern</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">pattern</span> <span class="ow">in</span> <span class="n">archive_patterns</span><span class="p">:</span>
            <span class="n">exp_pattern</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">expander</span><span class="o">.</span><span class="n">expand_var</span><span class="p">(</span><span class="n">pattern</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">file</span> <span class="ow">in</span> <span class="n">glob</span><span class="o">.</span><span class="n">glob</span><span class="p">(</span><span class="n">exp_pattern</span><span class="p">):</span>
                <span class="n">shutil</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="n">file</span><span class="p">,</span> <span class="n">archive_experiment_dir</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">file_name</span> <span class="ow">in</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">_inventory_file_name</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_status_file_name</span><span class="p">]:</span>
            <span class="n">file</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">experiment_run_dir</span><span class="p">,</span> <span class="n">file_name</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">file</span><span class="p">):</span>
                <span class="n">shutil</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="n">file</span><span class="p">,</span> <span class="n">archive_experiment_dir</span><span class="p">)</span>

    <span class="n">register_phase</span><span class="p">(</span><span class="s1">&#39;prepare_analysis&#39;</span><span class="p">,</span> <span class="n">pipeline</span><span class="o">=</span><span class="s1">&#39;analyze&#39;</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_prepare_analysis</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">workspace</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Prepapre experiment for analysis extraction</span>

<span class="sd">        This function performs any actions that are necessary before the</span>
<span class="sd">        figures of merit, and success criteria can be properly extracted.</span>

<span class="sd">        This function can be overridden at the application level to perform</span>
<span class="sd">        application specific processing of the output.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">pass</span>

    <span class="n">register_phase</span><span class="p">(</span><span class="s1">&#39;analyze_experiments&#39;</span><span class="p">,</span> <span class="n">pipeline</span><span class="o">=</span><span class="s1">&#39;analyze&#39;</span><span class="p">,</span> <span class="n">depends_on</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;prepare_analysis&#39;</span><span class="p">])</span>

    <span class="k">def</span> <span class="nf">_analyze_experiments</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">workspace</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Perform experiment analysis.</span>

<span class="sd">        This method will build up the fom_values dictionary. Its structure is:</span>

<span class="sd">        fom_values[context][fom]</span>

<span class="sd">        A fom can show up in any number of explicit contexts (including zero).</span>
<span class="sd">        If the number of explicit contexts is zero, the fom is associated with</span>
<span class="sd">        the default &#39;(null)&#39; context.</span>

<span class="sd">        Success is determined at analysis time as well. This happens by checking if:</span>
<span class="sd">         - At least one FOM is extracted</span>
<span class="sd">         AND</span>
<span class="sd">         - Any defined success criteria pass</span>

<span class="sd">        Success criteria are defined within the application.py, but can also be</span>
<span class="sd">        injected in a workspace config.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">def</span> <span class="nf">format_context</span><span class="p">(</span><span class="n">context_match</span><span class="p">,</span> <span class="n">context_format</span><span class="p">):</span>

            <span class="n">context_val</span> <span class="o">=</span> <span class="p">{}</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">context_format</span><span class="p">,</span> <span class="n">six</span><span class="o">.</span><span class="n">string_types</span><span class="p">):</span>
                <span class="k">for</span> <span class="n">group</span> <span class="ow">in</span> <span class="n">string</span><span class="o">.</span><span class="n">Formatter</span><span class="p">()</span><span class="o">.</span><span class="n">parse</span><span class="p">(</span><span class="n">context_format</span><span class="p">):</span>
                    <span class="k">if</span> <span class="n">group</span><span class="p">[</span><span class="mi">1</span><span class="p">]:</span>
                        <span class="n">context_val</span><span class="p">[</span><span class="n">group</span><span class="p">[</span><span class="mi">1</span><span class="p">]]</span> <span class="o">=</span> <span class="n">context_match</span><span class="p">[</span><span class="n">group</span><span class="p">[</span><span class="mi">1</span><span class="p">]]</span>

            <span class="n">context_string</span> <span class="o">=</span> <span class="n">context_format</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;{&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;}&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)</span> \
                <span class="o">+</span> <span class="s1">&#39; = &#39;</span> <span class="o">+</span> <span class="n">context_format</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="o">**</span><span class="n">context_val</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">context_string</span>

        <span class="n">fom_values</span> <span class="o">=</span> <span class="p">{}</span>

        <span class="n">criteria_list</span> <span class="o">=</span> <span class="n">workspace</span><span class="o">.</span><span class="n">success_list</span>

        <span class="n">files</span><span class="p">,</span> <span class="n">contexts</span><span class="p">,</span> <span class="n">foms</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_analysis_dicts</span><span class="p">(</span><span class="n">criteria_list</span><span class="p">)</span>

        <span class="c1"># Iterate over files. We already know they exist</span>
        <span class="k">for</span> <span class="n">file</span><span class="p">,</span> <span class="n">file_conf</span> <span class="ow">in</span> <span class="n">files</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>

            <span class="c1"># Start with no active contexts in a file.</span>
            <span class="n">active_contexts</span> <span class="o">=</span> <span class="p">{}</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Reading log file: </span><span class="si">{</span><span class="n">file</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>

            <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">file</span><span class="p">,</span> <span class="s1">&#39;r&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">f</span><span class="o">.</span><span class="n">readlines</span><span class="p">():</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Line: </span><span class="si">{</span><span class="n">line</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>

                    <span class="k">for</span> <span class="n">criteria</span> <span class="ow">in</span> <span class="n">file_conf</span><span class="p">[</span><span class="s1">&#39;success_criteria&#39;</span><span class="p">]:</span>
                        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;Looking for criteria </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">criteria</span><span class="p">)</span>
                        <span class="n">criteria_obj</span> <span class="o">=</span> <span class="n">criteria_list</span><span class="o">.</span><span class="n">find_criteria</span><span class="p">(</span><span class="n">criteria</span><span class="p">)</span>
                        <span class="k">if</span> <span class="n">criteria_obj</span><span class="o">.</span><span class="n">passed</span><span class="p">(</span><span class="n">line</span><span class="p">,</span> <span class="bp">self</span><span class="p">):</span>
                            <span class="n">criteria_obj</span><span class="o">.</span><span class="n">mark_found</span><span class="p">()</span>

                    <span class="k">for</span> <span class="n">context</span> <span class="ow">in</span> <span class="n">file_conf</span><span class="p">[</span><span class="s1">&#39;contexts&#39;</span><span class="p">]:</span>
                        <span class="n">context_conf</span> <span class="o">=</span> <span class="n">contexts</span><span class="p">[</span><span class="n">context</span><span class="p">]</span>
                        <span class="n">context_match</span> <span class="o">=</span> <span class="n">context_conf</span><span class="p">[</span><span class="s1">&#39;regex&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="n">line</span><span class="p">)</span>

                        <span class="k">if</span> <span class="n">context_match</span><span class="p">:</span>
                            <span class="n">context_name</span> <span class="o">=</span> \
                                <span class="n">format_context</span><span class="p">(</span><span class="n">context_match</span><span class="p">,</span>
                                               <span class="n">context_conf</span><span class="p">[</span><span class="s1">&#39;format&#39;</span><span class="p">])</span>
                            <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;Line was: </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">line</span><span class="p">)</span>
                            <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39; Context match </span><span class="si">{</span><span class="n">context</span><span class="si">}</span><span class="s1"> -- </span><span class="si">{</span><span class="n">context_name</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>

                            <span class="n">active_contexts</span><span class="p">[</span><span class="n">context</span><span class="p">]</span> <span class="o">=</span> <span class="n">context_name</span>

                            <span class="k">if</span> <span class="n">context_name</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">fom_values</span><span class="p">:</span>
                                <span class="n">fom_values</span><span class="p">[</span><span class="n">context_name</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>

                    <span class="k">for</span> <span class="n">fom</span> <span class="ow">in</span> <span class="n">file_conf</span><span class="p">[</span><span class="s1">&#39;foms&#39;</span><span class="p">]:</span>
                        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;  Testing for fom </span><span class="si">{</span><span class="n">fom</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
                        <span class="n">fom_conf</span> <span class="o">=</span> <span class="n">foms</span><span class="p">[</span><span class="n">fom</span><span class="p">]</span>
                        <span class="n">fom_match</span> <span class="o">=</span> <span class="n">fom_conf</span><span class="p">[</span><span class="s1">&#39;regex&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="n">line</span><span class="p">)</span>

                        <span class="k">if</span> <span class="n">fom_match</span><span class="p">:</span>
                            <span class="n">fom_vars</span> <span class="o">=</span> <span class="p">{}</span>
                            <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">fom_match</span><span class="o">.</span><span class="n">groupdict</span><span class="p">()</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                                <span class="n">fom_vars</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="n">v</span>
                            <span class="n">fom_name</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">expander</span><span class="o">.</span><span class="n">expand_var</span><span class="p">(</span><span class="n">fom</span><span class="p">,</span> <span class="n">extra_vars</span><span class="o">=</span><span class="n">fom_vars</span><span class="p">)</span>

                            <span class="k">if</span> <span class="n">fom_conf</span><span class="p">[</span><span class="s1">&#39;group&#39;</span><span class="p">]</span> <span class="ow">in</span> <span class="n">fom_conf</span><span class="p">[</span><span class="s1">&#39;regex&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">groupindex</span><span class="p">:</span>
                                <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39; --- Matched fom </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">fom_name</span><span class="p">)</span>
                                <span class="n">fom_contexts</span> <span class="o">=</span> <span class="p">[]</span>
                                <span class="k">if</span> <span class="n">fom_conf</span><span class="p">[</span><span class="s1">&#39;contexts&#39;</span><span class="p">]:</span>
                                    <span class="k">for</span> <span class="n">context</span> <span class="ow">in</span> <span class="n">fom_conf</span><span class="p">[</span><span class="s1">&#39;contexts&#39;</span><span class="p">]:</span>
                                        <span class="n">context_name</span> <span class="o">=</span> <span class="n">active_contexts</span><span class="p">[</span><span class="n">context</span><span class="p">]</span> \
                                            <span class="k">if</span> <span class="n">context</span> <span class="ow">in</span> <span class="n">active_contexts</span> \
                                            <span class="k">else</span> <span class="s1">&#39;null&#39;</span>
                                        <span class="n">fom_contexts</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">context_name</span><span class="p">)</span>
                                <span class="k">else</span><span class="p">:</span>
                                    <span class="n">fom_contexts</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;null&#39;</span><span class="p">)</span>

                                <span class="k">for</span> <span class="n">context</span> <span class="ow">in</span> <span class="n">fom_contexts</span><span class="p">:</span>
                                    <span class="k">if</span> <span class="n">context</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">fom_values</span><span class="p">:</span>
                                        <span class="n">fom_values</span><span class="p">[</span><span class="n">context</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
                                    <span class="n">fom_val</span> <span class="o">=</span> <span class="n">fom_match</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="n">fom_conf</span><span class="p">[</span><span class="s1">&#39;group&#39;</span><span class="p">])</span>
                                    <span class="n">fom_values</span><span class="p">[</span><span class="n">context</span><span class="p">][</span><span class="n">fom_name</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
                                        <span class="s1">&#39;value&#39;</span><span class="p">:</span> <span class="n">fom_val</span><span class="p">,</span>
                                        <span class="s1">&#39;units&#39;</span><span class="p">:</span> <span class="n">fom_conf</span><span class="p">[</span><span class="s1">&#39;units&#39;</span><span class="p">],</span>
                                        <span class="s1">&#39;origin&#39;</span><span class="p">:</span> <span class="n">fom_conf</span><span class="p">[</span><span class="s1">&#39;origin&#39;</span><span class="p">],</span>
                                        <span class="s1">&#39;origin_type&#39;</span><span class="p">:</span> <span class="n">fom_conf</span><span class="p">[</span><span class="s1">&#39;origin_type&#39;</span><span class="p">]</span>
                                    <span class="p">}</span>

        <span class="c1"># Test all non-file based success criteria</span>
        <span class="k">for</span> <span class="n">criteria_obj</span> <span class="ow">in</span> <span class="n">criteria_list</span><span class="o">.</span><span class="n">all_criteria</span><span class="p">():</span>
            <span class="k">if</span> <span class="n">criteria_obj</span><span class="o">.</span><span class="n">file</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">criteria_obj</span><span class="o">.</span><span class="n">passed</span><span class="p">(</span><span class="n">app_inst</span><span class="o">=</span><span class="bp">self</span><span class="p">,</span> <span class="n">fom_values</span><span class="o">=</span><span class="n">fom_values</span><span class="p">):</span>
                    <span class="n">criteria_obj</span><span class="o">.</span><span class="n">mark_found</span><span class="p">()</span>

        <span class="n">exp_ns</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">expander</span><span class="o">.</span><span class="n">experiment_namespace</span>
        <span class="n">results</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;name&#39;</span><span class="p">:</span> <span class="n">exp_ns</span><span class="p">}</span>

        <span class="n">success</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="k">for</span> <span class="n">fom</span> <span class="ow">in</span> <span class="n">fom_values</span><span class="o">.</span><span class="n">values</span><span class="p">():</span>
            <span class="k">for</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">fom</span><span class="o">.</span><span class="n">values</span><span class="p">():</span>
                <span class="k">if</span> <span class="s1">&#39;origin_type&#39;</span> <span class="ow">in</span> <span class="n">value</span> <span class="ow">and</span> <span class="n">value</span><span class="p">[</span><span class="s1">&#39;origin_type&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;application&#39;</span><span class="p">:</span>
                    <span class="n">success</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="n">success</span> <span class="o">=</span> <span class="n">success</span> <span class="ow">and</span> <span class="n">criteria_list</span><span class="o">.</span><span class="n">passed</span><span class="p">()</span>

        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;fom_values = </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">fom_values</span><span class="p">)</span>
        <span class="n">results</span><span class="p">[</span><span class="s1">&#39;EXPERIMENT_CHAIN&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">chain_order</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">success</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">set_status</span><span class="p">(</span><span class="n">status</span><span class="o">=</span><span class="s1">&#39;SUCCESS&#39;</span><span class="p">)</span>
            <span class="n">results</span><span class="p">[</span><span class="s1">&#39;RAMBLE_STATUS&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;SUCCESS&#39;</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">set_status</span><span class="p">(</span><span class="n">status</span><span class="o">=</span><span class="s1">&#39;FAILED&#39;</span><span class="p">)</span>
            <span class="n">results</span><span class="p">[</span><span class="s1">&#39;RAMBLE_STATUS&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;FAILED&#39;</span>

        <span class="k">if</span> <span class="n">success</span> <span class="ow">or</span> <span class="n">workspace</span><span class="o">.</span><span class="n">always_print_foms</span><span class="p">:</span>
            <span class="n">results</span><span class="p">[</span><span class="s1">&#39;RAMBLE_VARIABLES&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
            <span class="n">results</span><span class="p">[</span><span class="s1">&#39;RAMBLE_RAW_VARIABLES&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
            <span class="k">for</span> <span class="n">var</span><span class="p">,</span> <span class="n">val</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">variables</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                <span class="n">results</span><span class="p">[</span><span class="s1">&#39;RAMBLE_RAW_VARIABLES&#39;</span><span class="p">][</span><span class="n">var</span><span class="p">]</span> <span class="o">=</span> <span class="n">val</span>
                <span class="n">results</span><span class="p">[</span><span class="s1">&#39;RAMBLE_VARIABLES&#39;</span><span class="p">][</span><span class="n">var</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">expander</span><span class="o">.</span><span class="n">expand_var</span><span class="p">(</span><span class="n">val</span><span class="p">)</span>
            <span class="n">results</span><span class="p">[</span><span class="s1">&#39;CONTEXTS&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>

            <span class="k">for</span> <span class="n">context</span><span class="p">,</span> <span class="n">fom_map</span> <span class="ow">in</span> <span class="n">fom_values</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                <span class="n">context_map</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;name&#39;</span><span class="p">:</span> <span class="n">context</span><span class="p">,</span> <span class="s1">&#39;foms&#39;</span><span class="p">:</span> <span class="p">[]}</span>

                <span class="k">for</span> <span class="n">fom_name</span><span class="p">,</span> <span class="n">fom</span> <span class="ow">in</span> <span class="n">fom_map</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                    <span class="n">fom_copy</span> <span class="o">=</span> <span class="n">fom</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
                    <span class="n">fom_copy</span><span class="p">[</span><span class="s1">&#39;name&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">fom_name</span>
                    <span class="n">context_map</span><span class="p">[</span><span class="s1">&#39;foms&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">fom_copy</span><span class="p">)</span>

                <span class="n">results</span><span class="p">[</span><span class="s1">&#39;CONTEXTS&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">context_map</span><span class="p">)</span>

        <span class="n">workspace</span><span class="o">.</span><span class="n">append_result</span><span class="p">(</span><span class="n">results</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_new_file_dict</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Create a dictionary to represent a new log file&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="p">{</span>
            <span class="s1">&#39;success_criteria&#39;</span><span class="p">:</span> <span class="p">[],</span>
            <span class="s1">&#39;contexts&#39;</span><span class="p">:</span> <span class="p">[],</span>
            <span class="s1">&#39;foms&#39;</span><span class="p">:</span> <span class="p">[]</span>
        <span class="p">}</span>

    <span class="k">def</span> <span class="nf">_analysis_dicts</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">criteria_list</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Extract files that need to be analyzed.</span>

<span class="sd">        Process figures_of_merit, and return the manipulated dictionaries</span>
<span class="sd">        to allow them to be extracted.</span>

<span class="sd">        Additionally, ensure the success criteria list is complete.</span>

<span class="sd">        Returns:</span>
<span class="sd">            files (dict): All files that need to be processed</span>
<span class="sd">            contexts (dict): Any contexts that have been defined</span>
<span class="sd">            foms (dict): All figures of merit that need to be extracted</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">files</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">contexts</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">foms</span> <span class="o">=</span> <span class="p">{}</span>

        <span class="c1"># Add the application defined criteria</span>
        <span class="n">criteria_list</span><span class="o">.</span><span class="n">flush_scope</span><span class="p">(</span><span class="s1">&#39;application_definition&#39;</span><span class="p">)</span>

        <span class="n">success_lists</span> <span class="o">=</span> <span class="p">[</span>
            <span class="p">(</span><span class="s1">&#39;application_definition&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">success_criteria</span><span class="p">),</span>
        <span class="p">]</span>

        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39; Number of modifiers are: </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_modifier_instances</span><span class="p">)</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">mod</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_modifier_instances</span><span class="p">:</span>
            <span class="n">success_lists</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="s1">&#39;modifier_definition&#39;</span><span class="p">,</span> <span class="n">mod</span><span class="o">.</span><span class="n">success_criteria</span><span class="p">))</span>

        <span class="k">for</span> <span class="n">success_scope</span><span class="p">,</span> <span class="n">success_list</span> <span class="ow">in</span> <span class="n">success_lists</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">criteria</span><span class="p">,</span> <span class="n">conf</span> <span class="ow">in</span> <span class="n">success_list</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                <span class="k">if</span> <span class="n">conf</span><span class="p">[</span><span class="s1">&#39;mode&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;string&#39;</span><span class="p">:</span>
                    <span class="n">criteria_list</span><span class="o">.</span><span class="n">add_criteria</span><span class="p">(</span><span class="n">success_scope</span><span class="p">,</span> <span class="n">criteria</span><span class="p">,</span>
                                               <span class="n">conf</span><span class="p">[</span><span class="s1">&#39;mode&#39;</span><span class="p">],</span> <span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="n">conf</span><span class="p">[</span><span class="s1">&#39;match&#39;</span><span class="p">]),</span>
                                               <span class="n">conf</span><span class="p">[</span><span class="s1">&#39;file&#39;</span><span class="p">])</span>

        <span class="n">criteria_list</span><span class="o">.</span><span class="n">add_criteria</span><span class="p">(</span><span class="n">scope</span><span class="o">=</span><span class="s1">&#39;application_definition&#39;</span><span class="p">,</span>
                                   <span class="n">name</span><span class="o">=</span><span class="s1">&#39;_application_function&#39;</span><span class="p">,</span>
                                   <span class="n">mode</span><span class="o">=</span><span class="s1">&#39;application_function&#39;</span><span class="p">)</span>

        <span class="c1"># Extract file paths for all criteria</span>
        <span class="k">for</span> <span class="n">criteria</span> <span class="ow">in</span> <span class="n">criteria_list</span><span class="o">.</span><span class="n">all_criteria</span><span class="p">():</span>
            <span class="n">log_path</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">expander</span><span class="o">.</span><span class="n">expand_var</span><span class="p">(</span><span class="n">criteria</span><span class="o">.</span><span class="n">file</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">log_path</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">files</span> <span class="ow">and</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">log_path</span><span class="p">):</span>
                <span class="n">files</span><span class="p">[</span><span class="n">log_path</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_new_file_dict</span><span class="p">()</span>

            <span class="k">if</span> <span class="n">log_path</span> <span class="ow">in</span> <span class="n">files</span><span class="p">:</span>
                <span class="n">files</span><span class="p">[</span><span class="n">log_path</span><span class="p">][</span><span class="s1">&#39;success_criteria&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">criteria</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>

        <span class="c1"># Remap fom / context / file data</span>
        <span class="c1"># Could push this into the language features in the future</span>
        <span class="n">fom_definitions</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">figures_of_merit</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">fom</span><span class="p">,</span> <span class="n">fom_def</span> <span class="ow">in</span> <span class="n">fom_definitions</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="n">fom_def</span><span class="p">[</span><span class="s1">&#39;origin&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span>
            <span class="n">fom_def</span><span class="p">[</span><span class="s1">&#39;origin_type&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;application&#39;</span>

        <span class="n">fom_contexts</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">figure_of_merit_contexts</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">mod</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_modifier_instances</span><span class="p">:</span>
            <span class="n">fom_contexts</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">mod</span><span class="o">.</span><span class="n">figure_of_merit_contexts</span><span class="p">)</span>

            <span class="n">mod_vars</span> <span class="o">=</span> <span class="n">mod</span><span class="o">.</span><span class="n">modded_variables</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>

            <span class="k">for</span> <span class="n">fom</span><span class="p">,</span> <span class="n">fom_def</span> <span class="ow">in</span> <span class="n">mod</span><span class="o">.</span><span class="n">figures_of_merit</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                <span class="n">fom_definitions</span><span class="p">[</span><span class="n">fom</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;origin&#39;</span><span class="p">:</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">mod</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">,</span> <span class="s1">&#39;origin_type&#39;</span><span class="p">:</span> <span class="s1">&#39;modifier&#39;</span><span class="p">}</span>
                <span class="k">for</span> <span class="n">attr</span> <span class="ow">in</span> <span class="n">fom_def</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
                    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">fom_def</span><span class="p">[</span><span class="n">attr</span><span class="p">],</span> <span class="nb">list</span><span class="p">):</span>
                        <span class="n">fom_definitions</span><span class="p">[</span><span class="n">fom</span><span class="p">][</span><span class="n">attr</span><span class="p">]</span> <span class="o">=</span> <span class="n">fom_def</span><span class="p">[</span><span class="n">attr</span><span class="p">]</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">fom_definitions</span><span class="p">[</span><span class="n">fom</span><span class="p">][</span><span class="n">attr</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">expander</span><span class="o">.</span><span class="n">expand_var</span><span class="p">(</span><span class="n">fom_def</span><span class="p">[</span><span class="n">attr</span><span class="p">],</span>
                                                                              <span class="n">mod_vars</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">fom</span><span class="p">,</span> <span class="n">conf</span> <span class="ow">in</span> <span class="n">fom_definitions</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="n">log_path</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">expander</span><span class="o">.</span><span class="n">expand_var</span><span class="p">(</span><span class="n">conf</span><span class="p">[</span><span class="s1">&#39;log_file&#39;</span><span class="p">])</span>
            <span class="k">if</span> <span class="n">log_path</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">files</span> <span class="ow">and</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">log_path</span><span class="p">):</span>
                <span class="n">files</span><span class="p">[</span><span class="n">log_path</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_new_file_dict</span><span class="p">()</span>

            <span class="k">if</span> <span class="n">log_path</span> <span class="ow">in</span> <span class="n">files</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;Log = </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">log_path</span><span class="p">)</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;Conf = </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">conf</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">conf</span><span class="p">[</span><span class="s1">&#39;contexts&#39;</span><span class="p">]:</span>
                    <span class="n">files</span><span class="p">[</span><span class="n">log_path</span><span class="p">][</span><span class="s1">&#39;contexts&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">conf</span><span class="p">[</span><span class="s1">&#39;contexts&#39;</span><span class="p">])</span>
                <span class="n">files</span><span class="p">[</span><span class="n">log_path</span><span class="p">][</span><span class="s1">&#39;foms&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">fom</span><span class="p">)</span>

            <span class="n">foms</span><span class="p">[</span><span class="n">fom</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
                <span class="s1">&#39;regex&#39;</span><span class="p">:</span> <span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;</span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">conf</span><span class="p">[</span><span class="s1">&#39;regex&#39;</span><span class="p">]),</span>
                <span class="s1">&#39;contexts&#39;</span><span class="p">:</span> <span class="p">[],</span>
                <span class="s1">&#39;group&#39;</span><span class="p">:</span> <span class="n">conf</span><span class="p">[</span><span class="s1">&#39;group_name&#39;</span><span class="p">],</span>
                <span class="s1">&#39;units&#39;</span><span class="p">:</span> <span class="n">conf</span><span class="p">[</span><span class="s1">&#39;units&#39;</span><span class="p">],</span>
                <span class="s1">&#39;origin&#39;</span><span class="p">:</span> <span class="n">conf</span><span class="p">[</span><span class="s1">&#39;origin&#39;</span><span class="p">],</span>
                <span class="s1">&#39;origin_type&#39;</span><span class="p">:</span> <span class="n">conf</span><span class="p">[</span><span class="s1">&#39;origin_type&#39;</span><span class="p">]</span>
            <span class="p">}</span>
            <span class="k">if</span> <span class="n">conf</span><span class="p">[</span><span class="s1">&#39;contexts&#39;</span><span class="p">]:</span>
                <span class="n">foms</span><span class="p">[</span><span class="n">fom</span><span class="p">][</span><span class="s1">&#39;contexts&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">conf</span><span class="p">[</span><span class="s1">&#39;contexts&#39;</span><span class="p">])</span>

            <span class="k">if</span> <span class="n">conf</span><span class="p">[</span><span class="s1">&#39;contexts&#39;</span><span class="p">]:</span>
                <span class="k">for</span> <span class="n">context</span> <span class="ow">in</span> <span class="n">conf</span><span class="p">[</span><span class="s1">&#39;contexts&#39;</span><span class="p">]:</span>
                    <span class="n">regex_str</span> <span class="o">=</span> \
                        <span class="n">fom_contexts</span><span class="p">[</span><span class="n">context</span><span class="p">][</span><span class="s1">&#39;regex&#39;</span><span class="p">]</span>
                    <span class="n">format_str</span> <span class="o">=</span> \
                        <span class="n">fom_contexts</span><span class="p">[</span><span class="n">context</span><span class="p">][</span><span class="s1">&#39;output_format&#39;</span><span class="p">]</span>
                    <span class="n">contexts</span><span class="p">[</span><span class="n">context</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
                        <span class="s1">&#39;regex&#39;</span><span class="p">:</span> <span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;</span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">regex_str</span><span class="p">),</span>
                        <span class="s1">&#39;format&#39;</span><span class="p">:</span> <span class="n">format_str</span>
                    <span class="p">}</span>

            <span class="k">if</span> <span class="n">conf</span><span class="p">[</span><span class="s1">&#39;contexts&#39;</span><span class="p">]:</span>
                <span class="k">for</span> <span class="n">context</span> <span class="ow">in</span> <span class="n">conf</span><span class="p">[</span><span class="s1">&#39;contexts&#39;</span><span class="p">]:</span>
                    <span class="n">regex_str</span> <span class="o">=</span> \
                        <span class="n">fom_contexts</span><span class="p">[</span><span class="n">context</span><span class="p">][</span><span class="s1">&#39;regex&#39;</span><span class="p">]</span>
                    <span class="n">format_str</span> <span class="o">=</span> \
                        <span class="n">fom_contexts</span><span class="p">[</span><span class="n">context</span><span class="p">][</span><span class="s1">&#39;output_format&#39;</span><span class="p">]</span>
                    <span class="n">contexts</span><span class="p">[</span><span class="n">context</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
                        <span class="s1">&#39;regex&#39;</span><span class="p">:</span> <span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;</span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">regex_str</span><span class="p">),</span>
                        <span class="s1">&#39;format&#39;</span><span class="p">:</span> <span class="n">format_str</span>
                    <span class="p">}</span>
        <span class="k">return</span> <span class="n">files</span><span class="p">,</span> <span class="n">contexts</span><span class="p">,</span> <span class="n">foms</span>

<div class="viewcode-block" id="ApplicationBase.read_status">
<a class="viewcode-back" href="../../ramble.html#ramble.application.ApplicationBase.read_status">[docs]</a>
    <span class="k">def</span> <span class="nf">read_status</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Read status from an experiment&#39;s status file, if possible.</span>

<span class="sd">        Set this experiment&#39;s status based on the status file in the experiment</span>
<span class="sd">        run directory, if it exists. If it doesn&#39;t exist, set its status to</span>
<span class="sd">        UNKNOWN</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">status_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">expander</span><span class="o">.</span><span class="n">expand_var_name</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">keywords</span><span class="o">.</span><span class="n">experiment_run_dir</span><span class="p">),</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_status_file_name</span>
        <span class="p">)</span>

        <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="n">status_path</span><span class="p">):</span>
            <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">status_path</span><span class="p">,</span> <span class="s1">&#39;r&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
                <span class="n">status_data</span> <span class="o">=</span> <span class="n">spack</span><span class="o">.</span><span class="n">util</span><span class="o">.</span><span class="n">spack_json</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">variables</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">keywords</span><span class="o">.</span><span class="n">experiment_status</span><span class="p">]</span> <span class="o">=</span> \
                <span class="n">status_data</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">keywords</span><span class="o">.</span><span class="n">experiment_status</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">variables</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">keywords</span><span class="o">.</span><span class="n">experiment_status</span><span class="p">]</span> <span class="o">=</span> \
                <span class="s1">&#39;UNKNOWN&#39;</span></div>


<div class="viewcode-block" id="ApplicationBase.set_status">
<a class="viewcode-back" href="../../ramble.html#ramble.application.ApplicationBase.set_status">[docs]</a>
    <span class="k">def</span> <span class="nf">set_status</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">status</span><span class="o">=</span><span class="s1">&#39;UNKNOWN&#39;</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Set the status of this experiment&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">variables</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">keywords</span><span class="o">.</span><span class="n">experiment_status</span><span class="p">]</span> <span class="o">=</span> <span class="n">status</span></div>


    <span class="n">register_phase</span><span class="p">(</span><span class="s1">&#39;write_status&#39;</span><span class="p">,</span> <span class="n">pipeline</span><span class="o">=</span><span class="s1">&#39;analyze&#39;</span><span class="p">,</span> <span class="n">depends_on</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;analyze_experiments&#39;</span><span class="p">])</span>
    <span class="n">register_phase</span><span class="p">(</span><span class="s1">&#39;write_status&#39;</span><span class="p">,</span> <span class="n">pipeline</span><span class="o">=</span><span class="s1">&#39;setup&#39;</span><span class="p">,</span> <span class="n">depends_on</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;make_experiments&#39;</span><span class="p">])</span>

    <span class="k">def</span> <span class="nf">_write_status</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">workspace</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Phase to write an experiment&#39;s ramble_status.json file&quot;&quot;&quot;</span>

        <span class="n">status_data</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">status_data</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">keywords</span><span class="o">.</span><span class="n">experiment_status</span><span class="p">]</span> <span class="o">=</span> \
            <span class="bp">self</span><span class="o">.</span><span class="n">expander</span><span class="o">.</span><span class="n">expand_var_name</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">keywords</span><span class="o">.</span><span class="n">experiment_status</span><span class="p">)</span>

        <span class="n">exp_dir</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">expander</span><span class="o">.</span><span class="n">expand_var_name</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">keywords</span><span class="o">.</span><span class="n">experiment_run_dir</span><span class="p">)</span>

        <span class="n">status_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span>
            <span class="n">exp_dir</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_status_file_name</span>
        <span class="p">)</span>

        <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">exp_dir</span><span class="p">):</span>
            <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">status_path</span><span class="p">,</span> <span class="s1">&#39;w+&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
                <span class="n">spack</span><span class="o">.</span><span class="n">util</span><span class="o">.</span><span class="n">spack_json</span><span class="o">.</span><span class="n">dump</span><span class="p">(</span><span class="n">status_data</span><span class="p">,</span> <span class="n">f</span><span class="p">)</span>

    <span class="n">register_builtin</span><span class="p">(</span><span class="s1">&#39;env_vars&#39;</span><span class="p">,</span> <span class="n">required</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

<div class="viewcode-block" id="ApplicationBase.env_vars">
<a class="viewcode-back" href="../../ramble.html#ramble.application.ApplicationBase.env_vars">[docs]</a>
    <span class="k">def</span> <span class="nf">env_vars</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">command</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="c1"># ensure license variables are set / modified</span>
        <span class="c1"># Process one scope at a time, to ensure</span>
        <span class="c1"># highest-precedence scopes are processed last</span>
        <span class="n">config_scopes</span> <span class="o">=</span> <span class="n">ramble</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">scopes</span><span class="p">()</span>
        <span class="n">shell</span> <span class="o">=</span> <span class="n">ramble</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;config:shell&#39;</span><span class="p">)</span>

        <span class="n">action_funcs</span> <span class="o">=</span> <span class="n">ramble</span><span class="o">.</span><span class="n">util</span><span class="o">.</span><span class="n">env</span><span class="o">.</span><span class="n">action_funcs</span>

        <span class="k">for</span> <span class="n">scope</span> <span class="ow">in</span> <span class="n">config_scopes</span><span class="p">:</span>
            <span class="n">license_conf</span> <span class="o">=</span> <span class="n">ramble</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">get_config</span><span class="p">(</span><span class="s1">&#39;licenses&#39;</span><span class="p">,</span>
                                                           <span class="n">scope</span><span class="o">=</span><span class="n">scope</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">license_conf</span><span class="p">:</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span> <span class="ow">in</span> <span class="n">license_conf</span><span class="p">:</span>
                    <span class="n">app_licenses</span> <span class="o">=</span> <span class="n">license_conf</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">]</span>
                    <span class="k">if</span> <span class="n">app_licenses</span><span class="p">:</span>
                        <span class="c1"># Append logic to source file which contains the exports</span>
                        <span class="n">command</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;. </span><span class="se">{{</span><span class="s2">license_input_dir</span><span class="se">}}</span><span class="s2">/</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">license_inc_name</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="c1"># Process environment variable actions</span>
        <span class="k">for</span> <span class="n">env_var_set</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_env_variable_sets</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">action</span><span class="p">,</span> <span class="n">conf</span> <span class="ow">in</span> <span class="n">env_var_set</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                <span class="p">(</span><span class="n">env_cmds</span><span class="p">,</span> <span class="n">_</span><span class="p">)</span> <span class="o">=</span> <span class="n">action_funcs</span><span class="p">[</span><span class="n">action</span><span class="p">](</span><span class="n">conf</span><span class="p">,</span>
                                                     <span class="nb">set</span><span class="p">(),</span>
                                                     <span class="n">shell</span><span class="o">=</span><span class="n">shell</span><span class="p">)</span>

                <span class="k">for</span> <span class="n">cmd</span> <span class="ow">in</span> <span class="n">env_cmds</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">cmd</span><span class="p">:</span>
                        <span class="n">command</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">cmd</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">mod_inst</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_modifier_instances</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">action</span><span class="p">,</span> <span class="n">conf</span> <span class="ow">in</span> <span class="n">mod_inst</span><span class="o">.</span><span class="n">all_env_var_modifications</span><span class="p">():</span>
                <span class="p">(</span><span class="n">env_cmds</span><span class="p">,</span> <span class="n">_</span><span class="p">)</span> <span class="o">=</span> <span class="n">action_funcs</span><span class="p">[</span><span class="n">action</span><span class="p">](</span><span class="n">conf</span><span class="p">,</span>
                                                     <span class="nb">set</span><span class="p">(),</span>
                                                     <span class="n">shell</span><span class="o">=</span><span class="n">shell</span><span class="p">)</span>

                <span class="k">for</span> <span class="n">cmd</span> <span class="ow">in</span> <span class="n">env_cmds</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">cmd</span><span class="p">:</span>
                        <span class="n">command</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">cmd</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">command</span></div>


<div class="viewcode-block" id="ApplicationBase.evaluate_success">
<a class="viewcode-back" href="../../ramble.html#ramble.application.ApplicationBase.evaluate_success">[docs]</a>
    <span class="k">def</span> <span class="nf">evaluate_success</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Hook for applications to evaluate custom success criteria</span>

<span class="sd">        Expected to perform analysis and return either true or false.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">return</span> <span class="kc">True</span></div>
</div>



<div class="viewcode-block" id="ApplicationError">
<a class="viewcode-back" href="../../ramble.html#ramble.application.ApplicationError">[docs]</a>
<span class="k">class</span> <span class="nc">ApplicationError</span><span class="p">(</span><span class="n">RambleError</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Exception that is raised by applications</span>
<span class="sd">    &quot;&quot;&quot;</span></div>



<div class="viewcode-block" id="PhaseCycleDetectedError">
<a class="viewcode-back" href="../../ramble.html#ramble.application.PhaseCycleDetectedError">[docs]</a>
<span class="k">class</span> <span class="nc">PhaseCycleDetectedError</span><span class="p">(</span><span class="n">ApplicationError</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Exception raised when a cycle is detected while ordering phases</span>
<span class="sd">    &quot;&quot;&quot;</span></div>



<div class="viewcode-block" id="InvalidPhaseError">
<a class="viewcode-back" href="../../ramble.html#ramble.application.InvalidPhaseError">[docs]</a>
<span class="k">class</span> <span class="nc">InvalidPhaseError</span><span class="p">(</span><span class="n">ApplicationError</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Exception raised when a phase is used but not defined</span>
<span class="sd">    &quot;&quot;&quot;</span></div>



<div class="viewcode-block" id="ChainCycleDetectedError">
<a class="viewcode-back" href="../../ramble.html#ramble.application.ChainCycleDetectedError">[docs]</a>
<span class="k">class</span> <span class="nc">ChainCycleDetectedError</span><span class="p">(</span><span class="n">ApplicationError</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Exception raised when a cycle is detected in a defined experiment chain</span>
<span class="sd">    &quot;&quot;&quot;</span></div>



<div class="viewcode-block" id="InvalidChainError">
<a class="viewcode-back" href="../../ramble.html#ramble.application.InvalidChainError">[docs]</a>
<span class="k">class</span> <span class="nc">InvalidChainError</span><span class="p">(</span><span class="n">ApplicationError</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Exception raised when a invalid chained experiment is defined</span>
<span class="sd">    &quot;&quot;&quot;</span></div>

</pre></div>

           </div>
          </div>
          <footer>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2022-2023, Google LLC.
      <span class="lastupdated">Last updated on Dec 18, 2023.
      </span></p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>